<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الكاشير العراقي - النسخة الكاملة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #8B0000;
            --secondary-color: #CD853F;
            --accent-color: #DAA520;
            --success-color: #2E8B57;
            --info-color: #4682B4;
            --warning-color: #FF8C00;
            --light-color: #F5F5DC;
            --dark-color: #556B2F;
            --text-color: #333;
            --border-radius: 8px;
            --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #F5F5DC;
            color: var(--text-color);
            margin: 0;
            min-height: 100vh;
            direction: rtl;
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .cashier-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            margin-bottom: 20px;
            border: 2px solid var(--accent-color);
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--accent-color);
        }

        .header h1 {
            font-size: 1.8rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-info {
            display: flex;
            gap: 15px;
        }

        .header-info-item {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .header-info-item span:first-child {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .header-info-item span:last-child {
            font-weight: bold;
        }

        .top-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
            border-bottom: 1px solid var(--secondary-color);
            background-color: var(--light-color);
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-item label {
            font-weight: bold;
            color: var(--dark-color);
        }

        .info-item input, 
        .info-item select {
            padding: 10px;
            border: 1px solid var(--secondary-color);
            border-radius: var(--border-radius);
            background-color: white;
            font-family: inherit;
            transition: var(--transition);
            width: 100%;
        }

        .info-item input:focus, 
        .info-item select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(218, 165, 32, 0.3);
        }

        .button-group {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            border-bottom: 1px solid var(--secondary-color);
            background-color: var(--light-color);
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn i {
            font-size: 1rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #6B0000;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #217645;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #E07B00;
        }

        .btn-danger {
            background-color: var(--accent-color);
            color: #333;
        }

        .btn-danger:hover {
            background-color: #C59400;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #B3742B;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            padding: 20px;
        }

        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .product-input-area {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .product-input-area label {
            font-weight: bold;
            color: var(--dark-color);
            margin-bottom: 5px;
            display: block;
        }

        .product-input-area input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--secondary-color);
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .product-input-area input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(218, 165, 32, 0.3);
        }

        .add-item-btn {
            grid-column: span 2;
            padding: 12px;
            font-size: 1rem;
            background-color: var(--dark-color);
            color: white;
        }

        .add-item-btn:hover {
            background-color: #455825;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .sidebar-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr));
            gap: 10px;
        }

        .quick-actions {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: var(--border-radius);
            border: 1px solid var(--secondary-color);
        }

        .quick-actions h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            padding: 15px;
        }

        .table-section {
            overflow-x: auto;
            padding: 0 20px 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--secondary-color);
        }

        table th {
            background: linear-gradient(to bottom, var(--primary-color), #6B0000);
            color: white;
            padding: 12px 15px;
            text-align: right;
            font-weight: bold;
            border: 1px solid var(--accent-color);
        }

        table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--secondary-color);
            text-align: right;
            background-color: white;
        }

        table tr:nth-child(even) {
            background-color: rgba(205, 133, 63, 0.1);
        }

        table tr:hover {
            background-color: rgba(218, 165, 32, 0.2);
        }

        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
            margin-left: 5px;
            font-size: 0.9rem;
        }

        .edit-btn {
            background-color: var(--warning-color);
            color: white;
        }

        .edit-btn:hover {
            background-color: #E07B00;
        }

        .delete-btn {
            background-color: var(--primary-color);
            color: white;
        }

        .delete-btn:hover {
            background-color: #6B0000;
        }

        .footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: var(--light-color);
            border-top: 1px solid var(--secondary-color);
        }

        .total-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .total-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .search-invoice {
            display: flex;
            gap: 10px;
        }

        .search-invoice input {
            padding: 10px;
            border: 1px solid var(--secondary-color);
            border-radius: var(--border-radius);
            min-width: 200px;
        }

        .save-section {
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .save-btn {
            padding: 12px 40px;
            font-size: 1.1rem;
            background: linear-gradient(to right, var(--primary-color), var(--dark-color));
            color: white;
            border: none;
            border-radius: 30px;
        }

        .save-btn:hover {
            opacity: 0.9;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 90%;
            max-width: 500px;
            overflow: hidden;
            animation: modalFadeIn 0.3s;
            border: 2px solid var(--accent-color);
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--accent-color);
        }

        .modal-header h3 {
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            background-color: var(--light-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-top: 1px solid var(--secondary-color);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: var(--success-color);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1100;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background-color: var(--primary-color);
        }

        .toast.warning {
            background-color: var(--warning-color);
        }

        /* Management Sections */
        .management-section {
            display: none;
            padding: 20px;
        }

        .management-section.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-grid button {
            grid-column: span 2;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th, 
        .data-table td {
            padding: 12px 15px;
            border: 1px solid var(--secondary-color);
            text-align: right;
        }

        .data-table th {
            background-color: var(--primary-color);
            color: white;
        }

        .data-table tr:nth-child(even) {
            background-color: rgba(205, 133, 63, 0.1);
        }

        /* Tabs for management sections */
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--accent-color);
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: var(--light-color);
            border: 1px solid var(--secondary-color);
            border-bottom: none;
            margin-left: 5px;
            border-radius: 5px 5px 0 0;
            transition: var(--transition);
        }

        .tab.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .tab:hover:not(.active) {
            background-color: rgba(139, 0, 0, 0.1);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .header-info {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .footer {
                flex-direction: column;
                gap: 15px;
            }
            
            .total-section {
                flex-direction: column;
                gap: 10px;
            }
            
            .product-input-area {
                grid-template-columns: 1fr 1fr;
            }
            
            .add-item-btn {
                grid-column: span 2;
            }
            
            .search-invoice {
                flex-direction: column;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-grid button {
                grid-column: span 1;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                margin-bottom: 5px;
            }
        }

        /* Animation for buttons */
        .btn-pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(139, 0, 0, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(139, 0, 0, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(139, 0, 0, 0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="cashier-container">
            <!-- Cashier Interface (Main Page) -->
            <div id="cashierInterface">
                <div class="header">
                    <h1><i class="fas fa-cash-register"></i> نظام الكاشير العراقي</h1>
                    <div class="header-info">
                        <div class="header-info-item">
                            <span>المستخدم</span>
                            <span id="adminNameDisplay">admin</span>
                        </div>
                        <div class="header-info-item">
                            <span>التاريخ</span>
                            <span id="currentDateDisplay">--/--/----</span>
                        </div>
                    </div>
                </div>

                <div class="top-info">
                    <div class="info-item">
                        <label for="shopName">اسم المحل:</label>
                        <input type="text" id="shopName" value="متجر الرشيد">
                    </div>
                    <div class="info-item">
                        <label for="invoiceNumber">رقم الفاتورة:</label>
                        <input type="text" id="invoiceNumber" value="1">
                    </div>
                    <div class="info-item">
                        <label for="paymentMethod">طريقة الدفع:</label>
                        <select id="paymentMethod">
                            <option value="cash">كاش</option>
                            <option value="card">بطاقة</option>
                            <option value="bank">تحويل بنكي</option>
                        </select>
                    </div>
                    <div class="info-item">
                        <label for="customerName">اسم العميل (اختياري):</label>
                        <input type="text" id="customerName" placeholder="اسم العميل">
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" id="linkInvoiceBtn"><i class="fas fa-link"></i> ربط على الفاتورة</button>
                    <button class="btn btn-success" id="sendHandBtn"><i class="fas fa-paper-plane"></i> ارسال اليد</button>
                    <button class="btn btn-warning" id="returnHandBtn"><i class="fas fa-undo"></i> استرداد اليد</button>
                    <button class="btn btn-secondary" id="discountBtn"><i class="fas fa-percentage"></i> خصم على الفاتورة</button>
                </div>

                <div class="main-content">
                    <div class="product-section">
                        <div class="product-input-area">
                            <div>
                                <label for="itemCodeCashier">كود المنتج:</label>
                                <input type="text" id="itemCodeCashier" placeholder="أدخل كود المنتج">
                            </div>
                            <div>
                                <label for="productNameCashier">اسم المنتج:</label>
                                <input type="text" id="productNameCashier" placeholder="سيظهر تلقائياً" readonly>
                            </div>
                            <div>
                                <label for="priceCashier">السعر:</label>
                                <input type="number" id="priceCashier" placeholder="سعر الوحدة" min="0" step="0.01">
                            </div>
                            <div>
                                <label for="quantityCashier">الكمية:</label>
                                <input type="number" id="quantityCashier" value="1" min="1">
                            </div>
                            <div>
                                <label for="discount">الخصم:</label>
                                <input type="number" id="discount" value="0" min="0" step="0.01">
                            </div>
                            <div>
                                <label for="delivery">التوصيل:</label>
                                <input type="number" id="delivery" value="0" min="0" step="0.01">
                            </div>
                            <button class="btn btn-success add-item-btn" id="addItemToInvoice">
                                <i class="fas fa-plus-circle"></i> إضافة للمنتجات
                            </button>
                        </div>
                    </div>

                    <div class="sidebar">
                        <div class="quick-actions">
                            <h3><i class="fas fa-bolt"></i> إجراءات سريعة</h3>
                            <div class="sidebar-buttons">
                                <button class="btn btn-danger" id="clearBtn"><i class="fas fa-trash"></i> تفريغ</button>
                                <button class="btn btn-primary" id="printBtn"><i class="fas fa-print"></i> طباعة</button>
                                <button class="btn btn-warning" id="debtsBtn"><i class="fas fa-file-invoice-dollar"></i> الديون</button>
                                <button class="btn btn-secondary" id="warehouseBtn"><i class="fas fa-warehouse"></i> المخزن</button>
                            </div>
                        </div>

                        <div class="quick-actions">
                            <h3><i class="fas fa-boxes"></i> معلومات المخزون</h3>
                            <div id="stockInfo">
                                <p style="text-align: center; color: var(--primary-color);"><i class="fas fa-info-circle"></i> أدخل كود المنتج لعرض المعلومات</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="manageInvoicesBtn"><i class="fas fa-file-invoice"></i> إدارة الفواتير</button>
                    <button class="btn btn-success" id="manageProductsBtn"><i class="fas fa-box-open"></i> إدارة المنتجات</button>
                    <button class="btn btn-warning" id="reportsBtn"><i class="fas fa-chart-bar"></i> التقارير</button>
                    <button class="btn btn-info" id="dailySalesBtn"><i class="fas fa-calendar-day"></i> المبيعات اليومية</button>
                    <button class="btn btn-secondary" id="settingsBtn"><i class="fas fa-cog"></i> الإعدادات</button>
                </div>

                <div class="table-section">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>المنتج</th>
                                <th>الكمية</th>
                                <th>السعر</th>
                                <th>الخصم</th>
                                <th>الإجمالي</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="invoiceTableBody">
                            <!-- Items will be added here dynamically -->
                        </tbody>
                    </table>
                </div>

                <div class="footer">
                    <div class="total-section">
                        <span style="font-weight: bold;">الإجمالي:</span>
                        <span class="total-amount" id="totalAmount">0.00</span>
                        <span style="font-weight: bold;">دينار عراقي</span>
                    </div>
                    <div class="search-invoice">
                        <input type="text" id="searchInvoiceNumber" placeholder="بحث برقم الفاتورة">
                        <button class="btn btn-primary" id="searchInvoiceButton"><i class="fas fa-search"></i> بحث</button>
                    </div>
                </div>

                <div class="save-section">
                    <button class="btn btn-success save-btn btn-pulse" id="saveInvoiceButton">
                        <i class="fas fa-save"></i> حفظ الفاتورة
                    </button>
                </div>
            </div>

            <!-- Product Management Interface -->
            <div id="productManagement" class="management-section">
                <div class="header">
                    <h1><i class="fas fa-box-open"></i> إدارة المنتجات</h1>
                    <button class="btn btn-secondary" id="backToCashier">
                        <i class="fas fa-arrow-left"></i> العودة للكاشير
                    </button>
                </div>

                <div class="main-content">
                    <div class="form-grid">
                        <div class="info-item">
                            <label for="productCode">كود المنتج:</label>
                            <input type="text" id="productCode" placeholder="أدخل كود المنتج">
                        </div>
                        <div class="info-item">
                            <label for="productName">اسم المنتج:</label>
                            <input type="text" id="productName" placeholder="أدخل اسم المنتج">
                        </div>
                        <div class="info-item">
                            <label for="productPrice">السعر:</label>
                            <input type="number" id="productPrice" placeholder="سعر الوحدة" min="0" step="0.01">
                        </div>
                        <div class="info-item">
                            <label for="productQuantity">الكمية في المخزن:</label>
                            <input type="number" id="productQuantity" placeholder="الكمية المتاحة" min="0">
                        </div>
                        <div class="info-item">
                            <label for="productUnit">وحدة القياس:</label>
                            <input type="text" id="productUnit" placeholder="كيلو، علبة، لتر...">
                        </div>
                        <div class="info-item">
                            <label for="productCategory">التصنيف:</label>
                            <input type="text" id="productCategory" placeholder="تصنيف المنتج">
                        </div>
                        <div class="info-item">
                            <label for="productBarcode">باركود (اختياري):</label>
                            <input type="text" id="productBarcode" placeholder="باركود المنتج">
                        </div>
                        <button class="btn btn-success" id="addProductBtn">
                            <i class="fas fa-plus"></i> إضافة منتج
                        </button>
                        <button class="btn btn-primary" id="updateProductBtn" style="display: none;">
                            <i class="fas fa-save"></i> تحديث المنتج
                        </button>
                        <button class="btn btn-secondary" id="cancelEditProductBtn" style="display: none;">
                            <i class="fas fa-times"></i> إلغاء
                        </button>
                    </div>

                    <div class="table-section">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>كود المنتج</th>
                                    <th>اسم المنتج</th>
                                    <th>السعر</th>
                                    <th>الكمية</th>
                                    <th>وحدة القياس</th>
                                    <th>التصنيف</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <!-- Products will be added here dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Warehouse Management Interface -->
            <div id="warehouseManagement" class="management-section">
                <div class="header">
                    <h1><i class="fas fa-warehouse"></i> إدارة المخزن</h1>
                    <button class="btn btn-secondary" id="backToCashierFromWarehouse">
                        <i class="fas fa-arrow-left"></i> العودة للكاشير
                    </button>
                </div>

                <div class="tabs">
                    <div class="tab active" data-tab="stock">المخزون الحالي</div>
                    <div class="tab" data-tab="addStock">إضافة مخزون</div>
                    <div class="tab" data-tab="stockHistory">سجل المخزون</div>
                </div>

                <div class="tab-content" id="stockTab">
                    <div class="main-content">
                        <div class="table-section">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>كود المنتج</th>
                                        <th>اسم المنتج</th>
                                        <th>السعر</th>
                                        <th>الكمية المتاحة</th>
                                        <th>وحدة القياس</th>
                                        <th>التصنيف</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="warehouseTableBody">
                                    <!-- Warehouse items will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="addStockTab" style="display: none;">
                    <div class="main-content">
                        <div class="form-grid">
                            <div class="info-item">
                                <label for="warehouseProductCode">كود المنتج:</label>
                                <input type="text" id="warehouseProductCode" placeholder="أدخل كود المنتج">
                            </div>
                            <div class="info-item">
                                <label for="warehouseProductName">اسم المنتج:</label>
                                <input type="text" id="warehouseProductName" placeholder="سيظهر تلقائياً" readonly>
                            </div>
                            <div class="info-item">
                                <label for="warehouseCurrentStock">المخزون الحالي:</label>
                                <input type="text" id="warehouseCurrentStock" readonly>
                            </div>
                            <div class="info-item">
                                <label for="warehouseAddQuantity">الكمية المضافة:</label>
                                <input type="number" id="warehouseAddQuantity" min="1" value="1">
                            </div>
                            <div class="info-item">
                                <label for="warehouseAddReason">سبب الإضافة:</label>
                                <select id="warehouseAddReason">
                                    <option value="purchase">شراء جديد</option>
                                    <option value="return">مرتجع</option>
                                    <option value="adjustment">تعديل مخزون</option>
                                    <option value="other">أخرى</option>
                                </select>
                            </div>
                            <div class="info-item">
                                <label for="warehouseAddNotes">ملاحظات (اختياري):</label>
                                <input type="text" id="warehouseAddNotes" placeholder="ملاحظات حول الإضافة">
                            </div>
                            <button class="btn btn-success" id="addStockBtn">
                                <i class="fas fa-plus"></i> إضافة للمخزون
                            </button>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="stockHistoryTab" style="display: none;">
                    <div class="main-content">
                        <div class="form-grid">
                            <div class="info-item">
                                <label for="stockHistoryFilter">تصفية حسب:</label>
                                <select id="stockHistoryFilter">
                                    <option value="all">الكل</option>
                                    <option value="today">اليوم</option>
                                    <option value="week">هذا الأسبوع</option>
                                    <option value="month">هذا الشهر</option>
                                    <option value="product">منتج معين</option>
                                </select>
                            </div>
                            <div class="info-item" id="productCodeFilterContainer" style="display: none;">
                                <label for="stockHistoryProductCode">كود المنتج:</label>
                                <input type="text" id="stockHistoryProductCode" placeholder="أدخل كود المنتج">
                            </div>
                            <button class="btn btn-primary" id="applyStockHistoryFilter">
                                <i class="fas fa-filter"></i> تطبيق التصفية
                            </button>
                        </div>

                        <div class="table-section">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>التاريخ</th>
                                        <th>كود المنتج</th>
                                        <th>اسم المنتج</th>
                                        <th>الكمية</th>
                                        <th>النوع</th>
                                        <th>السبب</th>
                                        <th>المستخدم</th>
                                    </tr>
                                </thead>
                                <tbody id="stockHistoryTableBody">
                                    <!-- Stock history will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invoices Management Interface -->
            <div id="invoicesManagement" class="management-section">
                <div class="header">
                    <h1><i class="fas fa-file-invoice"></i> إدارة الفواتير</h1>
                    <button class="btn btn-secondary" id="backToCashierFromInvoices">
                        <i class="fas fa-arrow-left"></i> العودة للكاشير
                    </button>
                </div>

                <div class="tabs">
                    <div class="tab active" data-tab="allInvoices">جميع الفواتير</div>
                    <div class="tab" data-tab="todayInvoices">فواتير اليوم</div>
                    <div class="tab" data-tab="returnedInvoices">المرتجعات</div>
                </div>

                <div class="tab-content" id="allInvoicesTab">
                    <div class="main-content">
                        <div class="form-grid">
                            <div class="info-item">
                                <label for="invoiceFilterDateFrom">من تاريخ:</label>
                                <input type="date" id="invoiceFilterDateFrom">
                            </div>
                            <div class="info-item">
                                <label for="invoiceFilterDateTo">إلى تاريخ:</label>
                                <input type="date" id="invoiceFilterDateTo">
                            </div>
                            <div class="info-item">
                                <label for="invoiceFilterCustomer">اسم العميل:</label>
                                <input type="text" id="invoiceFilterCustomer" placeholder="اسم العميل">
                            </div>
                            <div class="info-item">
                                <label for="invoiceFilterPayment">طريقة الدفع:</label>
                                <select id="invoiceFilterPayment">
                                    <option value="all">الكل</option>
                                    <option value="cash">كاش</option>
                                    <option value="card">بطاقة</option>
                                    <option value="bank">تحويل بنكي</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" id="applyInvoiceFilter">
                                <i class="fas fa-filter"></i> تطبيق التصفية
                            </button>
                            <button class="btn btn-secondary" id="resetInvoiceFilter">
                                <i class="fas fa-redo"></i> إعادة تعيين
                            </button>
                        </div>

                        <div class="table-section">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>رقم الفاتورة</th>
                                        <th>التاريخ</th>
                                        <th>العميل</th>
                                        <th>عدد المنتجات</th>
                                        <th>المجموع</th>
                                        <th>طريقة الدفع</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="invoicesTableBody">
                                    <!-- Invoices will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="todayInvoicesTab" style="display: none;">
                    <div class="main-content">
                        <div class="table-section">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>رقم الفاتورة</th>
                                        <th>الوقت</th>
                                        <th>العميل</th>
                                        <th>عدد المنتجات</th>
                                        <th>المجموع</th>
                                        <th>طريقة الدفع</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="todayInvoicesTableBody">
                                    <!-- Today's invoices will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="returnedInvoicesTab" style="display: none;">
                    <div class="main-content">
                        <div class="table-section">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>رقم الفاتورة</th>
                                        <th>تاريخ الإرجاع</th>
                                        <th>العميل</th>
                                        <th>عدد المنتجات</th>
                                        <th>المجموع</th>
                                        <th>سبب الإرجاع</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="returnedInvoicesTableBody">
                                    <!-- Returned invoices will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Debts Management Interface -->
            <div id="debtsManagement" class="management-section">
                <div class="header">
                    <h1><i class="fas fa-file-invoice-dollar"></i> إدارة الديون</h1>
                    <button class="btn btn-secondary" id="backToCashierFromDebts">
                        <i class="fas fa-arrow-left"></i> العودة للكاشير
                    </button>
                </div>

                <div class="tabs">
                    <div class="tab active" data-tab="allDebts">جميع الديون</div>
                    <div class="tab" data-tab="addDebt">إضافة دين</div>
                    <div class="tab" data-tab="debtPayments">سجل السداد</div>
                </div>

                <div class="tab-content" id="allDebtsTab">
                    <div class="main-content">
                        <div class="form-grid">
                            <div class="info-item">
                                <label for="debtFilterCustomer">اسم العميل:</label>
                                <input type="text" id="debtFilterCustomer" placeholder="اسم العميل">
                            </div>
                            <div class="info-item">
                                <label for="debtFilterStatus">حالة الدين:</label>
                                <select id="debtFilterStatus">
                                    <option value="all">الكل</option>
                                    <option value="paid">مسددة</option>
                                    <option value="unpaid">غير مسددة</option>
                                    <option value="overdue">متأخرة</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" id="applyDebtFilter">
                                <i class="fas fa-filter"></i> تطبيق التصفية
                            </button>
                        </div>

                        <div class="table-section">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>اسم العميل</th>
                                        <th>رقم الفاتورة</th>
                                        <th>المبلغ</th>
                                        <th>المسدد</th>
                                        <th>المتبقي</th>
                                        <th>تاريخ الاستحقاق</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="debtsTableBody">
                                    <!-- Debts will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="addDebtTab" style="display: none;">
                    <div class="main-content">
                        <div class="form-grid">
                            <div class="info-item">
                                <label for="debtCustomerName">اسم العميل:</label>
                                <input type="text" id="debtCustomerName" placeholder="اسم العميل">
                            </div>
                            <div class="info-item">
                                <label for="debtInvoiceNumber">رقم الفاتورة (اختياري):</label>
                                <input type="text" id="debtInvoiceNumber" placeholder="رقم الفاتورة">
                            </div>
                            <div class="info-item">
                                <label for="debtAmount">المبلغ:</label>
                                <input type="number" id="debtAmount" min="0" step="0.01" placeholder="مبلغ الدين">
                            </div>
                            <div class="info-item">
                                <label for="debtDueDate">تاريخ الاستحقاق:</label>
                                <input type="date" id="debtDueDate">
                            </div>
                            <div class="info-item">
                                <label for="debtNotes">ملاحظات (اختياري):</label>
                                <textarea id="debtNotes" rows="2" placeholder="ملاحظات حول الدين"></textarea>
                            </div>
                            <button class="btn btn-success" id="saveDebtBtn">
                                <i class="fas fa-save"></i> حفظ الدين
                            </button>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="debtPaymentsTab" style="display: none;">
                    <div class="main-content">
                        <div class="form-grid">
                            <div class="info-item">
                                <label for="paymentFilterCustomer">اسم العميل:</label>
                                <input type="text" id="paymentFilterCustomer" placeholder="اسم العميل">
                            </div>
                            <div class="info-item">
                                <label for="paymentFilterDateFrom">من تاريخ:</label>
                                <input type="date" id="paymentFilterDateFrom">
                            </div>
                            <div class="info-item">
                                <label for="paymentFilterDateTo">إلى تاريخ:</label>
                                <input type="date" id="paymentFilterDateTo">
                            </div>
                            <button class="btn btn-primary" id="applyPaymentFilter">
                                <i class="fas fa-filter"></i> تطبيق التصفية
                            </button>
                        </div>

                        <div class="table-section">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>التاريخ</th>
                                        <th>اسم العميل</th>
                                        <th>رقم الفاتورة</th>
                                        <th>المبلغ المسدد</th>
                                        <th>طريقة السداد</th>
                                        <th>ملاحظات</th>
                                    </tr>
                                </thead>
                                <tbody id="debtPaymentsTableBody">
                                    <!-- Debt payments will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Interface -->
            <div id="reportsManagement" class="management-section">
                <div class="header">
                    <h1><i class="fas fa-chart-bar"></i> التقارير والإحصائيات</h1>
                    <button class="btn btn-secondary" id="backToCashierFromReports">
                        <i class="fas fa-arrow-left"></i> العودة للكاشير
                    </button>
                </div>

                <div class="tabs">
                    <div class="tab active" data-tab="salesReports">تقارير المبيعات</div>
                    <div class="tab" data-tab="productsReports">تقارير المنتجات</div>
                    <div class="tab" data-tab="financialReports">تقارير مالية</div>
                </div>

                <div class="tab-content" id="salesReportsTab">
                    <div class="main-content">
                        <div class="form-grid">
                            <div class="info-item">
                                <label for="salesReportType">نوع التقرير:</label>
                                <select id="salesReportType">
                                    <option value="daily">يومي</option>
                                    <option value="weekly">أسبوعي</option>
                                    <option value="monthly">شهري</option>
                                    <option value="yearly">سنوي</option>
                                    <option value="custom">مخصص</option>
                                </select>
                            </div>
                            <div class="info-item" id="salesReportCustomDate" style="display: none;">
                                <label for="salesReportDateFrom">من تاريخ:</label>
                                <input type="date" id="salesReportDateFrom">
                            </div>
                            <div class="info-item" id="salesReportCustomDateTo" style="display: none;">
                                <label for="salesReportDateTo">إلى تاريخ:</label>
                                <input type="date" id="salesReportDateTo">
                            </div>
                            <div class="info-item">
                                <label for="salesReportPaymentMethod">طريقة الدفع:</label>
                                <select id="salesReportPaymentMethod">
                                    <option value="all">الكل</option>
                                    <option value="cash">كاش</option>
                                    <option value="card">بطاقة</option>
                                    <option value="bank">تحويل بنكي</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" id="generateSalesReport">
                                <i class="fas fa-chart-line"></i> توليد التقرير
                            </button>
                        </div>

                        <div class="table-section">
                            <div id="salesReportChart" style="height: 300px; margin: 20px 0; background-color: #f9f9f9; border: 1px solid #ddd; display: flex; justify-content: center; align-items: center;">
                                <p>سيظهر الرسم البياني هنا بعد توليد التقرير</p>
                            </div>

                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>الفترة</th>
                                        <th>عدد الفواتير</th>
                                        <th>إجمالي المبيعات</th>
                                        <th>إجمالي الخصومات</th>
                                        <th>صافي المبيعات</th>
                                    </tr>
                                </thead>
                                <tbody id="salesReportTableBody">
                                    <!-- Sales report data will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="productsReportsTab" style="display: none;">
                    <div class="main-content">
                        <div class="form-grid">
                            <div class="info-item">
                                <label for="productsReportType">نوع التقرير:</label>
                                <select id="productsReportType">
                                    <option value="topSelling">الأكثر مبيعاً</option>
                                    <option value="lowStock">منخفضة المخزون</option>
                                    <option value="notSelling">غير المباعة</option>
                                    <option value="byCategory">حسب التصنيف</option>
                                </select>
                            </div>
                            <div class="info-item" id="productsReportCategoryContainer" style="display: none;">
                                <label for="productsReportCategory">التصنيف:</label>
                                <select id="productsReportCategory">
                                    <option value="all">الكل</option>
                                    <!-- Categories will be added dynamically -->
                                </select>
                            </div>
                            <div class="info-item">
                                <label for="productsReportPeriod">الفترة:</label>
                                <select id="productsReportPeriod">
                                    <option value="all">الكل</option>
                                    <option value="today">اليوم</option>
                                    <option value="week">هذا الأسبوع</option>
                                    <option value="month">هذا الشهر</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" id="generateProductsReport">
                                <i class="fas fa-chart-pie"></i> توليد التقرير
                            </button>
                        </div>

                        <div class="table-section">
                            <div id="productsReportChart" style="height: 300px; margin: 20px 0; background-color: #f9f9f9; border: 1px solid #ddd; display: flex; justify-content: center; align-items: center;">
                                <p>سيظهر الرسم البياني هنا بعد توليد التقرير</p>
                            </div>

                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>اسم المنتج</th>
                                        <th>الكمية المباعة</th>
                                        <th>إجمالي المبيعات</th>
                                        <th>المخزون الحالي</th>
                                        <th>نسبة المبيعات</th>
                                    </tr>
                                </thead>
                                <tbody id="productsReportTableBody">
                                    <!-- Products report data will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="financialReportsTab" style="display: none;">
                    <div class="main-content">
                        <div class="form-grid">
                            <div class="info-item">
                                <label for="financialReportType">نوع التقرير:</label>
                                <select id="financialReportType">
                                    <option value="profit">الأرباح والخسائر</option>
                                    <option value="expenses">المصروفات</option>
                                    <option value="debts">الديون</option>
                                    <option value="cashflow">التدفق النقدي</option>
                                </select>
                            </div>
                            <div class="info-item">
                                <label for="financialReportPeriod">الفترة:</label>
                                <select id="financialReportPeriod">
                                    <option value="today">اليوم</option>
                                    <option value="week">هذا الأسبوع</option>
                                    <option value="month">هذا الشهر</option>
                                    <option value="year">هذه السنة</option>
                                    <option value="custom">مخصص</option>
                                </select>
                            </div>
                            <div class="info-item" id="financialReportCustomDate" style="display: none;">
                                <label for="financialReportDateFrom">من تاريخ:</label>
                                <input type="date" id="financialReportDateFrom">
                            </div>
                            <div class="info-item" id="financialReportCustomDateTo" style="display: none;">
                                <label for="financialReportDateTo">إلى تاريخ:</label>
                                <input type="date" id="financialReportDateTo">
                            </div>
                            <button class="btn btn-primary" id="generateFinancialReport">
                                <i class="fas fa-file-invoice-dollar"></i> توليد التقرير
                            </button>
                        </div>

                        <div class="table-section">
                            <div id="financialReportSummary" style="background-color: #f9f9f9; border: 1px solid #ddd; padding: 15px; margin-bottom: 20px;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                    <div style="background-color: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                        <h4 style="color: var(--primary-color); margin-bottom: 5px;">إجمالي المبيعات</h4>
                                        <p style="font-size: 1.2rem; font-weight: bold; color: var(--success-color);" id="totalSalesAmount">0.00 دينار</p>
                                    </div>
                                    <div style="background-color: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                        <h4 style="color: var(--primary-color); margin-bottom: 5px;">إجمالي المشتريات</h4>
                                        <p style="font-size: 1.2rem; font-weight: bold; color: var(--primary-color);" id="totalPurchasesAmount">0.00 دينار</p>
                                    </div>
                                    <div style="background-color: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                        <h4 style="color: var(--primary-color); margin-bottom: 5px;">إجمالي المصروفات</h4>
                                        <p style="font-size: 1.2rem; font-weight: bold; color: var(--warning-color);" id="totalExpensesAmount">0.00 دينار</p>
                                    </div>
                                    <div style="background-color: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                        <h4 style="color: var(--primary-color); margin-bottom: 5px;">صافي الربح</h4>
                                        <p style="font-size: 1.2rem; font-weight: bold; color: var(--dark-color);" id="netProfitAmount">0.00 دينار</p>
                                    </div>
                                </div>
                            </div>

                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>التاريخ</th>
                                        <th>النوع</th>
                                        <th>الوصف</th>
                                        <th>المبلغ</th>
                                        <th>طريقة الدفع</th>
                                        <th>ملاحظات</th>
                                    </tr>
                                </thead>
                                <tbody id="financialReportTableBody">
                                    <!-- Financial report data will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Daily Sales Interface -->
            <div id="dailySalesManagement" class="management-section">
                <div class="header">
                    <h1><i class="fas fa-calendar-day"></i> المبيعات اليومية</h1>
                    <button class="btn btn-secondary" id="backToCashierFromDailySales">
                        <i class="fas fa-arrow-left"></i> العودة للكاشير
                    </button>
                </div>

                <div class="main-content">
                    <div class="form-grid">
                        <div class="info-item">
                            <label for="dailySalesDate">اختر تاريخ:</label>
                            <input type="date" id="dailySalesDate" value="">
                        </div>
                        <button class="btn btn-primary" id="loadDailySales">
                            <i class="fas fa-search"></i> بحث
                        </button>
                    </div>

                    <div class="table-section">
                        <div id="dailySalesSummary" style="background-color: #f9f9f9; border: 1px solid #ddd; padding: 15px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div style="background-color: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                    <h4 style="color: var(--primary-color); margin-bottom: 5px;">عدد الفواتير</h4>
                                    <p style="font-size: 1.2rem; font-weight: bold;" id="dailyInvoicesCount">0</p>
                                </div>
                                <div style="background-color: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                    <h4 style="color: var(--primary-color); margin-bottom: 5px;">إجمالي المبيعات</h4>
                                    <p style="font-size: 1.2rem; font-weight: bold; color: var(--success-color);" id="dailyTotalSales">0.00 دينار</p>
                                </div>
                                <div style="background-color: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                    <h4 style="color: var(--primary-color); margin-bottom: 5px;">المبيعات نقداً</h4>
                                    <p style="font-size: 1.2rem; font-weight: bold;" id="dailyCashSales">0.00 دينار</p>
                                </div>
                                <div style="background-color: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                    <h4 style="color: var(--primary-color); margin-bottom: 5px;">المبيعات بالبطاقة</h4>
                                    <p style="font-size: 1.2rem; font-weight: bold;" id="dailyCardSales">0.00 دينار</p>
                                </div>
                            </div>
                        </div>

                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>رقم الفاتورة</th>
                                    <th>الوقت</th>
                                    <th>العميل</th>
                                    <th>عدد المنتجات</th>
                                    <th>المجموع</th>
                                    <th>طريقة الدفع</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="dailySalesTableBody">
                                <!-- Daily sales will be added here dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Interface -->
            <div id="settingsManagement" class="management-section">
                <div class="header">
                    <h1><i class="fas fa-cog"></i> إعدادات النظام</h1>
                    <button class="btn btn-secondary" id="backToCashierFromSettings">
                        <i class="fas fa-arrow-left"></i> العودة للكاشير
                    </button>
                </div>

                <div class="tabs">
                    <div class="tab active" data-tab="generalSettings">الإعدادات العامة</div>
                    <div class="tab" data-tab="usersSettings">إدارة المستخدمين</div>
                    <div class="tab" data-tab="backupSettings">النسخ الاحتياطي</div>
                </div>

                <div class="tab-content" id="generalSettingsTab">
                    <div class="main-content">
                        <div class="form-grid">
                            <div class="info-item">
                                <label for="shopNameSetting">اسم المحل:</label>
                                <input type="text" id="shopNameSetting" placeholder="اسم المحل">
                            </div>
                            <div class="info-item">
                                <label for="shopAddress">عنوان المحل:</label>
                                <input type="text" id="shopAddress" placeholder="عنوان المحل">
                            </div>
                            <div class="info-item">
                                <label for="shopPhone">هاتف المحل:</label>
                                <input type="text" id="shopPhone" placeholder="هاتف المحل">
                            </div>
                            <div class="info-item">
                                <label for="shopTaxNumber">الرقم الضريبي:</label>
                                <input type="text" id="shopTaxNumber" placeholder="الرقم الضريبي">
                            </div>
                            <div class="info-item">
                                <label for="defaultTaxRate">معدل الضريبة الافتراضي (%):</label>
                                <input type="number" id="defaultTaxRate" min="0" max="100" step="0.1" value="0">
                            </div>
                            <div class="info-item">
                                <label for="currencySymbol">رمز العملة:</label>
                                <input type="text" id="currencySymbol" placeholder="رمز العملة" value="دينار">
                            </div>
                            <div class="info-item">
                                <label for="printHeader">رأسية الطباعة:</label>
                                <textarea id="printHeader" rows="3" placeholder="نص رأسية الفاتورة المطبوع"></textarea>
                            </div>
                            <div class="info-item">
                                <label for="printFooter">تذييل الطباعة:</label>
                                <textarea id="printFooter" rows="3" placeholder="نص تذييل الفاتورة المطبوع"></textarea>
                            </div>
                            <button class="btn btn-success" id="saveGeneralSettings">
                                <i class="fas fa-save"></i> حفظ الإعدادات
                            </button>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="usersSettingsTab" style="display: none;">
                    <div class="main-content">
                        <div class="form-grid">
                            <div class="info-item">
                                <label for="newUsername">اسم المستخدم:</label>
                                <input type="text" id="newUsername" placeholder="اسم المستخدم الجديد">
                            </div>
                            <div class="info-item">
                                <label for="newUserPassword">كلمة المرور:</label>
                                <input type="password" id="newUserPassword" placeholder="كلمة المرور">
                            </div>
                            <div class="info-item">
                                <label for="newUserRole">الدور:</label>
                                <select id="newUserRole">
                                    <option value="admin">مدير</option>
                                    <option value="cashier">كاشير</option>
                                    <option value="inventory">مخازن</option>
                                </select>
                            </div>
                            <button class="btn btn-success" id="addUserBtn">
                                <i class="fas fa-user-plus"></i> إضافة مستخدم
                            </button>
                        </div>

                        <div class="table-section">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>اسم المستخدم</th>
                                        <th>الدور</th>
                                        <th>تاريخ الإنشاء</th>
                                        <th>حالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Users will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="backupSettingsTab" style="display: none;">
                    <div class="main-content">
                        <div class="form-grid">
                            <div class="info-item">
                                <label for="backupType">نوع النسخ الاحتياطي:</label>
                                <select id="backupType">
                                    <option value="full">كامل</option>
                                    <option value="invoices">الفواتير فقط</option>
                                    <option value="products">المنتجات فقط</option>
                                    <option value="custom">مخصص</option>
                                </select>
                            </div>
                            <div class="info-item" id="backupCustomOptions" style="display: none;">
                                <label>اختر الجداول:</label>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
                                    <label><input type="checkbox" name="backupTables" value="products" checked> المنتجات</label>
                                    <label><input type="checkbox" name="backupTables" value="invoices" checked> الفواتير</label>
                                    <label><input type="checkbox" name="backupTables" value="customers" checked> العملاء</label>
                                    <label><input type="checkbox" name="backupTables" value="debts" checked> الديون</label>
                                    <label><input type="checkbox" name="backupTables" value="users" checked> المستخدمين</label>
                                </div>
                            </div>
                            <div class="info-item">
                                <label for="backupFormat">صيغة الملف:</label>
                                <select id="backupFormat">
                                    <option value="json">JSON</option>
                                    <option value="csv">CSV</option>
                                    <option value="excel">Excel</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" id="createBackupBtn">
                                <i class="fas fa-download"></i> إنشاء نسخة احتياطية
                            </button>
                            <button class="btn btn-secondary" id="restoreBackupBtn">
                                <i class="fas fa-upload"></i> استعادة نسخة احتياطية
                            </button>
                        </div>

                        <div class="table-section">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>اسم الملف</th>
                                        <th>النوع</th>
                                        <th>الحجم</th>
                                        <th>تاريخ الإنشاء</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="backupsTableBody">
                                    <!-- Backup files will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Edit Item -->
    <div class="modal" id="editItemModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> تعديل المنتج</h3>
                <button class="close-btn" id="closeEditModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-item">
                    <label for="editProductName">اسم المنتج:</label>
                    <input type="text" id="editProductName" readonly>
                </div>
                <div class="info-item">
                    <label for="editPrice">السعر:</label>
                    <input type="number" id="editPrice" min="0" step="0.01">
                </div>
                <div class="info-item">
                    <label for="editQuantity">الكمية:</label>
                    <input type="number" id="editQuantity" min="1">
                </div>
                <div class="info-item">
                    <label for="editDiscount">الخصم:</label>
                    <input type="number" id="editDiscount" min="0" step="0.01">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEditBtn">إلغاء</button>
                <button class="btn btn-primary" id="saveEditBtn">حفظ التعديلات</button>
            </div>
        </div>
    </div>

    <!-- Modal for Discount -->
    <div class="modal" id="discountModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-percentage"></i> خصم على الفاتورة</h3>
                <button class="close-btn" id="closeDiscountModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-item">
                    <label for="invoiceDiscountType">نوع الخصم:</label>
                    <select id="invoiceDiscountType">
                        <option value="percentage">نسبة مئوية</option>
                        <option value="fixed">مبلغ ثابت</option>
                    </select>
                </div>
                <div class="info-item">
                    <label for="invoiceDiscountValue">قيمة الخصم:</label>
                    <input type="number" id="invoiceDiscountValue" min="0" step="0.01">
                </div>
                <div class="info-item">
                    <label for="invoiceDiscountReason">سبب الخصم (اختياري):</label>
                    <input type="text" id="invoiceDiscountReason" placeholder="سبب الخصم">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelDiscountBtn">إلغاء</button>
                <button class="btn btn-primary" id="applyDiscountBtn">تطبيق الخصم</button>
            </div>
        </div>
    </div>

    <!-- Modal for View Invoice -->
    <div class="modal" id="viewInvoiceModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-file-invoice"></i> عرض الفاتورة <span id="invoiceModalNumber"></span></h3>
                <button class="close-btn" id="closeViewInvoiceModal">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <div>
                        <p><strong>اسم المحل:</strong> <span id="invoiceModalShop"></span></p>
                        <p><strong>التاريخ:</strong> <span id="invoiceModalDate"></span></p>
                    </div>
                    <div>
                        <p><strong>اسم العميل:</strong> <span id="invoiceModalCustomer"></span></p>
                        <p><strong>طريقة الدفع:</strong> <span id="invoiceModalPayment"></span></p>
                    </div>
                </div>

                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <thead>
                        <tr style="background-color: var(--primary-color); color: white;">
                            <th style="padding: 10px; text-align: right;">#</th>
                            <th style="padding: 10px; text-align: right;">المنتج</th>
                            <th style="padding: 10px; text-align: right;">الكمية</th>
                            <th style="padding: 10px; text-align: right;">السعر</th>
                            <th style="padding: 10px; text-align: right;">الخصم</th>
                            <th style="padding: 10px; text-align: right;">الإجمالي</th>
                        </tr>
                    </thead>
                    <tbody id="viewInvoiceTableBody">
                        <!-- Invoice items will be added here dynamically -->
                    </tbody>
                </table>

                <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                    <div style="width: 300px; background-color: #f9f9f9; padding: 15px; border-radius: 5px;">
                        <p style="display: flex; justify-content: space-between;">
                            <strong>المجموع:</strong>
                            <span id="invoiceModalSubtotal"></span>
                        </p>
                        <p style="display: flex; justify-content: space-between;">
                            <strong>الخصم:</strong>
                            <span id="invoiceModalDiscount"></span>
                        </p>
                        <p style="display: flex; justify-content: space-between; font-size: 1.2rem; margin-top: 10px;">
                            <strong>الإجمالي النهائي:</strong>
                            <span id="invoiceModalTotal" style="color: var(--primary-color); font-weight: bold;"></span>
                        </p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="printInvoiceModalBtn">
                    <i class="fas fa-print"></i> طباعة الفاتورة
                </button>
                <button class="btn btn-primary" id="closeViewInvoiceBtn">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- Modal for Add Payment -->
    <div class="modal" id="addPaymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-money-bill-wave"></i> إضافة سداد</h3>
                <button class="close-btn" id="closeAddPaymentModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-item">
                    <label for="paymentCustomerName">اسم العميل:</label>
                    <input type="text" id="paymentCustomerName" readonly>
                </div>
                <div class="info-item">
                    <label for="paymentInvoiceNumber">رقم الفاتورة:</label>
                    <input type="text" id="paymentInvoiceNumber" readonly>
                </div>
                <div class="info-item">
                    <label for="paymentRemainingAmount">المبلغ المتبقي:</label>
                    <input type="text" id="paymentRemainingAmount" readonly>
                </div>
                <div class="info-item">
                    <label for="paymentAmount">مبلغ السداد:</label>
                    <input type="number" id="paymentAmount" min="0" step="0.01">
                </div>
                <div class="info-item">
                    <label for="paymentMethod">طريقة السداد:</label>
                    <select id="paymentMethod">
                        <option value="cash">نقداً</option>
                        <option value="card">بطاقة</option>
                        <option value="bank">تحويل بنكي</option>
                    </select>
                </div>
                <div class="info-item">
                    <label for="paymentNotes">ملاحظات (اختياري):</label>
                    <textarea id="paymentNotes" rows="2" placeholder="ملاحظات حول السداد"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelAddPaymentBtn">إلغاء</button>
                <button class="btn btn-primary" id="savePaymentBtn">حفظ السداد</button>
            </div>
        </div>
    </div>

    <!-- Modal for Return Invoice -->
    <div class="modal" id="returnInvoiceModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-undo"></i> إرجاع فاتورة <span id="returnInvoiceModalNumber"></span></h3>
                <button class="close-btn" id="closeReturnInvoiceModal">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <div>
                        <p><strong>اسم المحل:</strong> <span id="returnInvoiceModalShop"></span></p>
                        <p><strong>تاريخ الفاتورة:</strong> <span id="returnInvoiceModalDate"></span></p>
                    </div>
                    <div>
                        <p><strong>اسم العميل:</strong> <span id="returnInvoiceModalCustomer"></span></p>
                        <p><strong>المبلغ الأصلي:</strong> <span id="returnInvoiceModalTotal"></span></p>
                    </div>
                </div>

                <div class="info-item">
                    <label for="returnReason">سبب الإرجاع:</label>
                    <select id="returnReason">
                        <option value="defective">منتج معيب</option>
                        <option value="wrong">منتج خاطئ</option>
                        <option value="changeMind">تغيير رأي</option>
                        <option value="other">أخرى</option>
                    </select>
                </div>

                <div class="info-item" id="returnOtherReasonContainer" style="display: none;">
                    <label for="returnOtherReason">سبب الإرجاع (أخرى):</label>
                    <input type="text" id="returnOtherReason" placeholder="سبب الإرجاع">
                </div>

                <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                    <thead>
                        <tr style="background-color: var(--primary-color); color: white;">
                            <th style="padding: 10px; text-align: right;"></th>
                            <th style="padding: 10px; text-align: right;">المنتج</th>
                            <th style="padding: 10px; text-align: right;">الكمية المباعة</th>
                            <th style="padding: 10px; text-align: right;">الكمية المرتجعة</th>
                            <th style="padding: 10px; text-align: right;">المبلغ المرتجع</th>
                        </tr>
                    </thead>
                    <tbody id="returnInvoiceTableBody">
                        <!-- Return items will be added here dynamically -->
                    </tbody>
                </table>

                <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                    <div style="width: 300px; background-color: #f9f9f9; padding: 15px; border-radius: 5px;">
                        <p style="display: flex; justify-content: space-between; font-size: 1.2rem;">
                            <strong>المبلغ المرتجع:</strong>
                            <span id="returnInvoiceAmount" style="color: var(--primary-color); font-weight: bold;"></span>
                        </p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelReturnInvoiceBtn">إلغاء</button>
                <button class="btn btn-primary" id="confirmReturnInvoiceBtn">تأكيد الإرجاع</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toastNotification">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">تمت العملية بنجاح</span>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const currentDateDisplay = document.getElementById('currentDateDisplay');
            const adminNameDisplay = document.getElementById('adminNameDisplay');
            const shopNameInput = document.getElementById('shopName');
            const invoiceNumberInput = document.getElementById('invoiceNumber');
            const paymentMethodSelect = document.getElementById('paymentMethod');
            const customerNameInput = document.getElementById('customerName');
            
            const itemCodeInput = document.getElementById('itemCodeCashier');
            const productNameInput = document.getElementById('productNameCashier');
            const priceInput = document.getElementById('priceCashier');
            const quantityInput = document.getElementById('quantityCashier');
            const discountInput = document.getElementById('discount');
            const deliveryInput = document.getElementById('delivery');
            
            const addItemBtn = document.getElementById('addItemToInvoice');
            const invoiceTableBody = document.getElementById('invoiceTableBody');
            const totalAmountSpan = document.getElementById('totalAmount');
            const saveInvoiceBtn = document.getElementById('saveInvoiceButton');
            const searchInvoiceInput = document.getElementById('searchInvoiceNumber');
            const searchInvoiceBtn = document.getElementById('searchInvoiceButton');
            const stockInfoDiv = document.getElementById('stockInfo');
            
            // Interfaces
            const cashierInterface = document.getElementById('cashierInterface');
            const productManagement = document.getElementById('productManagement');
            const warehouseManagement = document.getElementById('warehouseManagement');
            const invoicesManagement = document.getElementById('invoicesManagement');
            const debtsManagement = document.getElementById('debtsManagement');
            const reportsManagement = document.getElementById('reportsManagement');
            const dailySalesManagement = document.getElementById('dailySalesManagement');
            const settingsManagement = document.getElementById('settingsManagement');
            
            // Navigation buttons
            const manageProductsBtn = document.getElementById('manageProductsBtn');
            const backToCashierBtn = document.getElementById('backToCashier');
            const warehouseBtn = document.getElementById('warehouseBtn');
            const backToCashierFromWarehouse = document.getElementById('backToCashierFromWarehouse');
            const manageInvoicesBtn = document.getElementById('manageInvoicesBtn');
            const backToCashierFromInvoices = document.getElementById('backToCashierFromInvoices');
            const debtsBtn = document.getElementById('debtsBtn');
            const backToCashierFromDebts = document.getElementById('backToCashierFromDebts');
            const reportsBtn = document.getElementById('reportsBtn');
            const backToCashierFromReports = document.getElementById('backToCashierFromReports');
            const dailySalesBtn = document.getElementById('dailySalesBtn');
            const backToCashierFromDailySales = document.getElementById('backToCashierFromDailySales');
            const settingsBtn = document.getElementById('settingsBtn');
            const backToCashierFromSettings = document.getElementById('backToCashierFromSettings');
            
            // Product Management Elements
            const productCodeInput = document.getElementById('productCode');
            const productNameInputPM = document.getElementById('productName');
            const productPriceInput = document.getElementById('productPrice');
            const productQuantityInput = document.getElementById('productQuantity');
            const productUnitInput = document.getElementById('productUnit');
            const productCategoryInput = document.getElementById('productCategory');
            const productBarcodeInput = document.getElementById('productBarcode');
            const addProductBtn = document.getElementById('addProductBtn');
            const updateProductBtn = document.getElementById('updateProductBtn');
            const cancelEditProductBtn = document.getElementById('cancelEditProductBtn');
            const productsTableBody = document.getElementById('productsTableBody');
            
            // Warehouse Management Elements
            const warehouseTableBody = document.getElementById('warehouseTableBody');
            const warehouseProductCode = document.getElementById('warehouseProductCode');
            const warehouseProductName = document.getElementById('warehouseProductName');
            const warehouseCurrentStock = document.getElementById('warehouseCurrentStock');
            const warehouseAddQuantity = document.getElementById('warehouseAddQuantity');
            const warehouseAddReason = document.getElementById('warehouseAddReason');
            const warehouseAddNotes = document.getElementById('warehouseAddNotes');
            const addStockBtn = document.getElementById('addStockBtn');
            const stockHistoryTableBody = document.getElementById('stockHistoryTableBody');
            
            // Invoices Management Elements
            const invoicesTableBody = document.getElementById('invoicesTableBody');
            const todayInvoicesTableBody = document.getElementById('todayInvoicesTableBody');
            const returnedInvoicesTableBody = document.getElementById('returnedInvoicesTableBody');
            
            // Debts Management Elements
            const debtsTableBody = document.getElementById('debtsTableBody');
            const debtPaymentsTableBody = document.getElementById('debtPaymentsTableBody');
            
            // Reports Management Elements
            const salesReportTableBody = document.getElementById('salesReportTableBody');
            const productsReportTableBody = document.getElementById('productsReportTableBody');
            const financialReportTableBody = document.getElementById('financialReportTableBody');
            
            // Daily Sales Elements
            const dailySalesTableBody = document.getElementById('dailySalesTableBody');
            
            // Settings Elements
            const usersTableBody = document.getElementById('usersTableBody');
            const backupsTableBody = document.getElementById('backupsTableBody');
            
            // Modal Elements
            const editItemModal = document.getElementById('editItemModal');
            const closeEditModalBtn = document.getElementById('closeEditModal');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const saveEditBtn = document.getElementById('saveEditBtn');
            const editProductNameInput = document.getElementById('editProductName');
            const editPriceInput = document.getElementById('editPrice');
            const editQuantityInput = document.getElementById('editQuantity');
            const editDiscountInput = document.getElementById('editDiscount');
            
            const discountModal = document.getElementById('discountModal');
            const closeDiscountModalBtn = document.getElementById('closeDiscountModal');
            const cancelDiscountBtn = document.getElementById('cancelDiscountBtn');
            const applyDiscountBtn = document.getElementById('applyDiscountBtn');
            const invoiceDiscountType = document.getElementById('invoiceDiscountType');
            const invoiceDiscountValue = document.getElementById('invoiceDiscountValue');
            const invoiceDiscountReason = document.getElementById('invoiceDiscountReason');
            
            const viewInvoiceModal = document.getElementById('viewInvoiceModal');
            const closeViewInvoiceModal = document.getElementById('closeViewInvoiceModal');
            const viewInvoiceTableBody = document.getElementById('viewInvoiceTableBody');
            const closeViewInvoiceBtn = document.getElementById('closeViewInvoiceBtn');
            
            const addPaymentModal = document.getElementById('addPaymentModal');
            const closeAddPaymentModal = document.getElementById('closeAddPaymentModal');
            const savePaymentBtn = document.getElementById('savePaymentBtn');
            const cancelAddPaymentBtn = document.getElementById('cancelAddPaymentBtn');
            
            const returnInvoiceModal = document.getElementById('returnInvoiceModal');
            const closeReturnInvoiceModal = document.getElementById('closeReturnInvoiceModal');
            const returnInvoiceTableBody = document.getElementById('returnInvoiceTableBody');
            const confirmReturnInvoiceBtn = document.getElementById('confirmReturnInvoiceBtn');
            const cancelReturnInvoiceBtn = document.getElementById('cancelReturnInvoiceBtn');
            
            // Toast Notification
            const toastNotification = document.getElementById('toastNotification');
            const toastMessage = document.getElementById('toastMessage');
            
            // Data
            let invoiceItems = [];
            let productsInStock = [];
            let invoices = [];
            let debts = [];
            let stockHistory = [];
            let users = [];
            let settings = {};
            let currentEditingIndex = -1;
            let currentEditingProductIndex = -1;
            let currentViewingInvoice = null;
            let currentEditingDebt = null;
            let invoiceDiscount = {
                type: 'fixed',
                value: 0,
                reason: ''
            };
            
            // Initialize the application
            function init() {
                // Set current date
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                currentDateDisplay.textContent = `${day}/${month}/${year}`;
                
                // Load data from localStorage
                loadData();
                
                // Load last invoice number
                loadLastInvoiceNumber();
                
                // Event listeners
                setupEventListeners();
                
                // Render empty tables
                renderInvoiceTable();
                renderProductsTable();
                renderWarehouseTable();
                renderInvoicesTable();
                renderDebtsTable();
                renderUsersTable();
                
                // Set today's date in daily sales
                document.getElementById('dailySalesDate').valueAsDate = now;
            }
            
            // Load all data from localStorage
            function loadData() {
                // Products
                const storedProducts = localStorage.getItem('warehouseProducts');
                productsInStock = storedProducts ? JSON.parse(storedProducts) : [
                    { code: '001', name: 'تمر حلوة', price: 15000, count: 50, unit: 'كيلو', category: 'تمور' },
                    { code: '002', name: 'شاي أحمد', price: 2500, count: 100, unit: 'علبة', category: 'مشروبات' },
                    { code: '003', name: 'قهوة عراقية', price: 10000, count: 30, unit: 'كيلو', category: 'مشروبات' },
                    { code: '004', name: 'رز العنبر', price: 3000, count: 80, unit: 'كيلو', category: 'أرز' },
                    { code: '005', name: 'زيت زيتون', price: 20000, count: 25, unit: 'لتر', category: 'زيوت' }
                ];
                
                // Invoices
                const storedInvoices = localStorage.getItem('allInvoices');
                invoices = storedInvoices ? JSON.parse(storedInvoices) : [];
                
                // Debts
                const storedDebts = localStorage.getItem('debts');
                debts = storedDebts ? JSON.parse(storedDebts) : [];
                
                // Stock History
                const storedStockHistory = localStorage.getItem('stockHistory');
                stockHistory = storedStockHistory ? JSON.parse(storedStockHistory) : [];
                
                // Users
                const storedUsers = localStorage.getItem('users');
                users = storedUsers ? JSON.parse(storedUsers) : [
                    { username: 'admin', password: 'admin123', role: 'admin', createdAt: new Date().toISOString(), active: true }
                ];
                
                // Settings
                const storedSettings = localStorage.getItem('settings');
                settings = storedSettings ? JSON.parse(storedSettings) : {
                    shopName: 'متجر الرشيد',
                    shopAddress: '',
                    shopPhone: '',
                    shopTaxNumber: '',
                    defaultTaxRate: 0,
                    currencySymbol: 'دينار',
                    printHeader: 'شكراً لزيارتكم\nمتجر الرشيد\nهاتف: 07701234567',
                    printFooter: 'معاودة الزيارة دائماً\nشكراً لثقتكم'
                };
                
                // Apply settings
                applySettings();
            }
            
            // Apply system settings
            function applySettings() {
                shopNameInput.value = settings.shopName;
                document.getElementById('shopNameSetting').value = settings.shopName;
                document.getElementById('shopAddress').value = settings.shopAddress;
                document.getElementById('shopPhone').value = settings.shopPhone;
                document.getElementById('shopTaxNumber').value = settings.shopTaxNumber;
                document.getElementById('defaultTaxRate').value = settings.defaultTaxRate;
                document.getElementById('currencySymbol').value = settings.currencySymbol;
                document.getElementById('printHeader').value = settings.printHeader;
                document.getElementById('printFooter').value = settings.printFooter;
            }
            
            // Save all data to localStorage
            function saveData() {
                localStorage.setItem('warehouseProducts', JSON.stringify(productsInStock));
                localStorage.setItem('allInvoices', JSON.stringify(invoices));
                localStorage.setItem('debts', JSON.stringify(debts));
                localStorage.setItem('stockHistory', JSON.stringify(stockHistory));
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('settings', JSON.stringify(settings));
            }
            
            // Update products in "warehouse"
            function updateProductsInWarehouse() {
                localStorage.setItem('warehouseProducts', JSON.stringify(productsInStock));
            }
            
            // Load last invoice number
            function loadLastInvoiceNumber() {
                if (invoices.length > 0) {
                    const lastInvoiceNo = parseInt(invoices[invoices.length - 1].invoiceNumber);
                    invoiceNumberInput.value = lastInvoiceNo + 1;
                } else {
                    invoiceNumberInput.value = 1;
                }
            }
            
            // Set up event listeners
            function setupEventListeners() {
                // Product code input - auto fill product details
                itemCodeInput.addEventListener('input', handleProductCodeInput);
                warehouseProductCode.addEventListener('input', handleWarehouseProductCodeInput);
                
                // Add item to invoice
                addItemBtn.addEventListener('click', addItemToInvoice);
                
                // Save invoice
                saveInvoiceBtn.addEventListener('click', saveInvoice);
                
                // Search invoice
                searchInvoiceBtn.addEventListener('click', searchInvoice);
                searchInvoiceInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') searchInvoice();
                });
                
                // Modal controls
                closeEditModalBtn.addEventListener('click', () => editItemModal.style.display = 'none');
                cancelEditBtn.addEventListener('click', () => editItemModal.style.display = 'none');
                saveEditBtn.addEventListener('click', saveEditedItem);
                
                // Discount modal
                document.getElementById('discountBtn').addEventListener('click', () => {
                    invoiceDiscountType.value = invoiceDiscount.type;
                    invoiceDiscountValue.value = invoiceDiscount.value;
                    invoiceDiscountReason.value = invoiceDiscount.reason;
                    discountModal.style.display = 'flex';
                });
                
                closeDiscountModalBtn.addEventListener('click', () => discountModal.style.display = 'none');
                cancelDiscountBtn.addEventListener('click', () => discountModal.style.display = 'none');
                applyDiscountBtn.addEventListener('click', applyInvoiceDiscount);
                
                // View invoice modal
                closeViewInvoiceModal.addEventListener('click', () => viewInvoiceModal.style.display = 'none');
                closeViewInvoiceBtn.addEventListener('click', () => viewInvoiceModal.style.display = 'none');
                document.getElementById('printInvoiceModalBtn').addEventListener('click', printCurrentInvoice);
                
                // Add payment modal
                closeAddPaymentModal.addEventListener('click', () => addPaymentModal.style.display = 'none');
                cancelAddPaymentBtn.addEventListener('click', () => addPaymentModal.style.display = 'none');
                savePaymentBtn.addEventListener('click', savePayment);
                
                // Return invoice modal
                closeReturnInvoiceModal.addEventListener('click', () => returnInvoiceModal.style.display = 'none');
                cancelReturnInvoiceBtn.addEventListener('click', () => returnInvoiceModal.style.display = 'none');
                confirmReturnInvoiceBtn.addEventListener('click', confirmReturnInvoice);
                document.getElementById('returnReason').addEventListener('change', (e) => {
                    document.getElementById('returnOtherReasonContainer').style.display = 
                        e.target.value === 'other' ? 'block' : 'none';
                });
                
                // Navigation between interfaces
                manageProductsBtn.addEventListener('click', () => showInterface('productManagement'));
                backToCashierBtn.addEventListener('click', () => showInterface('cashierInterface'));
                warehouseBtn.addEventListener('click', () => showInterface('warehouseManagement'));
                backToCashierFromWarehouse.addEventListener('click', () => showInterface('cashierInterface'));
                manageInvoicesBtn.addEventListener('click', () => showInterface('invoicesManagement'));
                backToCashierFromInvoices.addEventListener('click', () => showInterface('cashierInterface'));
                debtsBtn.addEventListener('click', () => showInterface('debtsManagement'));
                backToCashierFromDebts.addEventListener('click', () => showInterface('cashierInterface'));
                reportsBtn.addEventListener('click', () => showInterface('reportsManagement'));
                backToCashierFromReports.addEventListener('click', () => showInterface('cashierInterface'));
                dailySalesBtn.addEventListener('click', () => showInterface('dailySalesManagement'));
                backToCashierFromDailySales.addEventListener('click', () => showInterface('cashierInterface'));
                settingsBtn.addEventListener('click', () => showInterface('settingsManagement'));
                backToCashierFromSettings.addEventListener('click', () => showInterface('cashierInterface'));
                
                // Product management
                addProductBtn.addEventListener('click', addProduct);
                updateProductBtn.addEventListener('click', updateProduct);
                cancelEditProductBtn.addEventListener('click', cancelEditProduct);
                
                // Warehouse management
                addStockBtn.addEventListener('click', addStock);
                document.querySelectorAll('[data-tab]').forEach(tab => {
                    tab.addEventListener('click', switchTab);
                });
                document.getElementById('stockHistoryFilter').addEventListener('change', (e) => {
                    document.getElementById('productCodeFilterContainer').style.display = 
                        e.target.value === 'product' ? 'block' : 'none';
                });
                document.getElementById('applyStockHistoryFilter').addEventListener('click', applyStockHistoryFilter);
                
                // Invoices management
                document.getElementById('applyInvoiceFilter').addEventListener('click', applyInvoiceFilter);
                document.getElementById('resetInvoiceFilter').addEventListener('click', resetInvoiceFilter);
                
                // Debts management
                document.getElementById('applyDebtFilter').addEventListener('click', applyDebtFilter);
                document.getElementById('saveDebtBtn').addEventListener('click', saveDebt);
                document.getElementById('applyPaymentFilter').addEventListener('click', applyPaymentFilter);
                
                // Reports management
                document.getElementById('salesReportType').addEventListener('change', (e) => {
                    const showCustom = e.target.value === 'custom';
                    document.getElementById('salesReportCustomDate').style.display = showCustom ? 'block' : 'none';
                    document.getElementById('salesReportCustomDateTo').style.display = showCustom ? 'block' : 'none';
                });
                document.getElementById('generateSalesReport').addEventListener('click', generateSalesReport);
                
                document.getElementById('productsReportType').addEventListener('change', (e) => {
                    document.getElementById('productsReportCategoryContainer').style.display = 
                        e.target.value === 'byCategory' ? 'block' : 'none';
                });
                document.getElementById('generateProductsReport').addEventListener('click', generateProductsReport);
                
                document.getElementById('financialReportType').addEventListener('change', (e) => {
                    const showCustom = e.target.value === 'custom';
                    document.getElementById('financialReportCustomDate').style.display = showCustom ? 'block' : 'none';
                    document.getElementById('financialReportCustomDateTo').style.display = showCustom ? 'block' : 'none';
                });
                document.getElementById('generateFinancialReport').addEventListener('click', generateFinancialReport);
                
                // Daily sales
                document.getElementById('loadDailySales').addEventListener('click', loadDailySales);
                
                // Settings
                document.getElementById('saveGeneralSettings').addEventListener('click', saveGeneralSettings);
                document.getElementById('addUserBtn').addEventListener('click', addUser);
                document.getElementById('backupType').addEventListener('change', (e) => {
                    document.getElementById('backupCustomOptions').style.display = 
                        e.target.value === 'custom' ? 'block' : 'none';
                });
                document.getElementById('createBackupBtn').addEventListener('click', createBackup);
                document.getElementById('restoreBackupBtn').addEventListener('click', restoreBackup);
                
                // Other buttons
                document.getElementById('clearBtn').addEventListener('click', clearInvoice);
                document.getElementById('printBtn').addEventListener('click', printInvoice);
                document.getElementById('linkInvoiceBtn').addEventListener('click', linkInvoice);
                document.getElementById('sendHandBtn').addEventListener('click', sendHand);
                document.getElementById('returnHandBtn').addEventListener('click', returnHand);
            }
            
            // Show specific interface and hide others
            function showInterface(interfaceId) {
                // Hide all interfaces
                document.querySelectorAll('.management-section').forEach(section => {
                    section.style.display = 'none';
                });
                cashierInterface.style.display = 'none';
                
                // Show the requested interface
                if (interfaceId === 'cashierInterface') {
                    cashierInterface.style.display = 'block';
                } else {
                    document.getElementById(interfaceId).style.display = 'block';
                }
                
                // Refresh data if needed
                if (interfaceId === 'warehouseManagement') {
                    renderWarehouseTable();
                } else if (interfaceId === 'invoicesManagement') {
                    renderInvoicesTable();
                } else if (interfaceId === 'debtsManagement') {
                    renderDebtsTable();
                } else if (interfaceId === 'reportsManagement') {
                    generateSalesReport();
                } else if (interfaceId === 'dailySalesManagement') {
                    loadDailySales();
                } else if (interfaceId === 'settingsManagement') {
                    renderUsersTable();
                }
            }
            
            // Switch between tabs in management sections
            function switchTab(e) {
                const tabId = e.target.getAttribute('data-tab');
                const parentId = e.target.closest('.management-section').id;
                
                // Deactivate all tabs in this section
                document.querySelectorAll(`#${parentId} .tab`).forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Activate current tab
                e.target.classList.add('active');
                
                // Hide all tab contents in this section
                document.querySelectorAll(`#${parentId} .tab-content`).forEach(content => {
                    content.style.display = 'none';
                });
                
                // Show current tab content
                document.getElementById(`${tabId}Tab`).style.display = 'block';
                
                // Load data if needed
                if (tabId === 'stockHistory') {
                    applyStockHistoryFilter();
                } else if (tabId === 'todayInvoices') {
                    renderTodayInvoicesTable();
                } else if (tabId === 'returnedInvoices') {
                    renderReturnedInvoicesTable();
                } else if (tabId === 'addDebt') {
                    // Reset form
                    document.getElementById('debtCustomerName').value = '';
                    document.getElementById('debtInvoiceNumber').value = '';
                    document.getElementById('debtAmount').value = '';
                    document.getElementById('debtDueDate').valueAsDate = new Date();
                    document.getElementById('debtNotes').value = '';
                } else if (tabId === 'debtPayments') {
                    applyPaymentFilter();
                } else if (tabId === 'productsReports') {
                    generateProductsReport();
                } else if (tabId === 'financialReports') {
                    generateFinancialReport();
                } else if (tabId === 'usersSettings') {
                    renderUsersTable();
                } else if (tabId === 'backupSettings') {
                    // Load backup files list
                    loadBackupFiles();
                }
            }
            
            // Handle product code input - auto fill product details
            function handleProductCodeInput() {
                const code = itemCodeInput.value.trim();
                if (!code) {
                    productNameInput.value = '';
                    priceInput.value = '';
                    stockInfoDiv.innerHTML = '<p style="text-align: center; color: var(--primary-color);"><i class="fas fa-info-circle"></i> أدخل كود المنتج لعرض المعلومات</p>';
                    return;
                }
                
                const product = productsInStock.find(p => p.code === code);
                if (product) {
                    productNameInput.value = product.name;
                    priceInput.value = product.price;
                    
                    // Show stock info
                    stockInfoDiv.innerHTML = `
                        <div style="background-color: rgba(255,255,255,0.9); padding: 10px; border-radius: 5px; border: 1px solid var(--secondary-color);">
                            <p><strong><i class="fas fa-box"></i> الاسم:</strong> ${product.name}</p>
                            <p><strong><i class="fas fa-tag"></i> السعر:</strong> ${product.price.toLocaleString()} دينار</p>
                            <p><strong><i class="fas fa-cubes"></i> المخزون:</strong> ${product.count} ${product.unit || 'وحدة'}</p>
                        </div>
                    `;
                } else {
                    productNameInput.value = '';
                    priceInput.value = '';
                    stockInfoDiv.innerHTML = `
                        <div style="background-color: rgba(255,255,255,0.9); padding: 10px; border-radius: 5px; border: 1px solid var(--primary-color); color: var(--primary-color);">
                            <p><i class="fas fa-exclamation-triangle"></i> المنتج غير موجود في المخزن</p>
                        </div>
                    `;
                }
            }
            
            // Handle warehouse product code input
            function handleWarehouseProductCodeInput() {
                const code = warehouseProductCode.value.trim();
                if (!code) {
                    warehouseProductName.value = '';
                    warehouseCurrentStock.value = '';
                    return;
                }
                
                const product = productsInStock.find(p => p.code === code);
                if (product) {
                    warehouseProductName.value = product.name;
                    warehouseCurrentStock.value = `${product.count} ${product.unit || 'وحدة'}`;
                } else {
                    warehouseProductName.value = 'المنتج غير موجود';
                    warehouseCurrentStock.value = '0';
                }
            }
            
            // Add item to invoice
            function addItemToInvoice() {
                const code = itemCodeInput.value.trim();
                const name = productNameInput.value.trim();
                const price = parseFloat(priceInput.value);
                const quantity = parseInt(quantityInput.value);
                const discount = parseFloat(discountInput.value) || 0;
                const delivery = parseFloat(deliveryInput.value) || 0;
                
                if (!code || !name || isNaN(price) || price <= 0 || isNaN(quantity) || quantity <= 0) {
                    showToast('الرجاء إدخال بيانات المنتج بشكل صحيح', 'error');
                    return;
                }
                
                // Check if product exists in stock
                const productIndex = productsInStock.findIndex(p => p.code === code);
                if (productIndex === -1) {
                    showToast('المنتج غير موجود في المخزن', 'error');
                    return;
                }
                
                // Check available quantity
                if (productsInStock[productIndex].count < quantity) {
                    showToast(`الكمية المتاحة: ${productsInStock[productIndex].count} فقط`, 'error');
                    return;
                }
                
                // Deduct from stock
                productsInStock[productIndex].count -= quantity;
                updateProductsInWarehouse();
                
                // Add to stock history
                stockHistory.push({
                    date: new Date().toISOString(),
                    productCode: code,
                    productName: name,
                    quantity: -quantity,
                    type: 'sale',
                    notes: `بيع من خلال الفاتورة ${invoiceNumberInput.value}`,
                    user: adminNameDisplay.textContent
                });
                
                // Add to invoice items
                invoiceItems.push({
                    code,
                    name,
                    price,
                    quantity,
                    discount,
                    delivery,
                    date: currentDateDisplay.textContent,
                    unit: productsInStock[productIndex].unit || 'وحدة'
                });
                
                // Clear inputs
                itemCodeInput.value = '';
                productNameInput.value = '';
                priceInput.value = '';
                quantityInput.value = '1';
                discountInput.value = '0';
                deliveryInput.value = '0';
                stockInfoDiv.innerHTML = '<p style="text-align: center; color: var(--primary-color);"><i class="fas fa-info-circle"></i> أدخل كود المنتج لعرض المعلومات</p>';
                
                // Render table
                renderInvoiceTable();
                
                // Show success message
                showToast('تم إضافة المنتج إلى الفاتورة بنجاح');
                
                // Focus on product code input for next item
                itemCodeInput.focus();
            }
            
            // Render invoice table
            function renderInvoiceTable() {
                invoiceTableBody.innerHTML = '';
                let total = 0;
                
                invoiceItems.forEach((item, index) => {
                    const row = invoiceTableBody.insertRow();
                    const itemTotal = (item.price * item.quantity) - item.discount;
                    total += itemTotal;
                    
                    // Row number
                    const rowNumberCell = row.insertCell();
                    rowNumberCell.textContent = index + 1;
                    
                    // Product name
                    const nameCell = row.insertCell();
                    nameCell.textContent = `${item.name} (${item.unit})`;
                    
                    // Quantity
                    const quantityCell = row.insertCell();
                    quantityCell.textContent = item.quantity;
                    
                    // Price
                    const priceCell = row.insertCell();
                    priceCell.textContent = item.price.toLocaleString();
                    
                    // Discount
                    const discountCell = row.insertCell();
                    discountCell.textContent = item.discount.toLocaleString();
                    
                    // Total
                    const totalCell = row.insertCell();
                    totalCell.textContent = itemTotal.toLocaleString();
                    
                    // Actions
                    const actionsCell = row.insertCell();
                    
                    // Edit button
                    const editBtn = document.createElement('button');
                    editBtn.className = 'action-btn edit-btn';
                    editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                    editBtn.title = 'تعديل';
                    editBtn.onclick = () => editItem(index);
                    actionsCell.appendChild(editBtn);
                    
                    // Delete button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'action-btn delete-btn';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.title = 'حذف';
                    deleteBtn.onclick = () => deleteItem(index);
                    actionsCell.appendChild(deleteBtn);
                });
                
                // Apply invoice discount if any
                if (invoiceDiscount.value > 0) {
                    if (invoiceDiscount.type === 'percentage') {
                        total = total * (1 - (invoiceDiscount.value / 100));
                    } else {
                        total -= invoiceDiscount.value;
                    }
                }
                
                // Update total amount
                totalAmountSpan.textContent = total.toLocaleString();
            }
            
            // Edit item
            function editItem(index) {
                const item = invoiceItems[index];
                currentEditingIndex = index;
                
                editProductNameInput.value = item.name;
                editPriceInput.value = item.price;
                editQuantityInput.value = item.quantity;
                editDiscountInput.value = item.discount;
                
                editItemModal.style.display = 'flex';
            }
            
            // Save edited item
            function saveEditedItem() {
                if (currentEditingIndex === -1) return;
                
                const oldItem = invoiceItems[currentEditingIndex];
                const newPrice = parseFloat(editPriceInput.value);
                const newQuantity = parseInt(editQuantityInput.value);
                const newDiscount = parseFloat(editDiscountInput.value) || 0;
                
                if (isNaN(newPrice) || newPrice <= 0 || isNaN(newQuantity) || newQuantity <= 0) {
                    showToast('الرجاء إدخال بيانات صحيحة', 'error');
                    return;
                }
                
                // Calculate the difference in quantity to update stock
                const quantityDiff = newQuantity - oldItem.quantity;
                
                // Find product in stock
                const productIndex = productsInStock.findIndex(p => p.code === oldItem.code);
                if (productIndex !== -1) {
                    // Check if enough stock is available for the increase
                    if (quantityDiff > 0 && productsInStock[productIndex].count < quantityDiff) {
                        showToast('لا يوجد مخزون كافي لهذه الكمية', 'error');
                        return;
                    }
                    
                    // Update stock
                    productsInStock[productIndex].count -= quantityDiff;
                    updateProductsInWarehouse();
                    
                    // Add to stock history if quantity changed
                    if (quantityDiff !== 0) {
                        stockHistory.push({
                            date: new Date().toISOString(),
                            productCode: oldItem.code,
                            productName: oldItem.name,
                            quantity: -quantityDiff,
                            type: 'adjustment',
                            notes: `تعديل كمية في الفاتورة ${invoiceNumberInput.value}`,
                            user: adminNameDisplay.textContent
                        });
                    }
                }
                
                // Update item
                invoiceItems[currentEditingIndex] = {
                    ...oldItem,
                    price: newPrice,
                    quantity: newQuantity,
                    discount: newDiscount
                };
                
                // Render table
                renderInvoiceTable();
                
                // Close modal
                editItemModal.style.display = 'none';
                currentEditingIndex = -1;
                
                // Show success message
                showToast('تم تعديل المنتج بنجاح');
            }
            
            // Delete item
            function deleteItem(index) {
                if (!confirm('هل أنت متأكد من حذف هذا المنتج من الفاتورة؟')) return;
                
                const deletedItem = invoiceItems[index];
                
                // Return quantity to stock
                const productIndex = productsInStock.findIndex(p => p.code === deletedItem.code);
                if (productIndex !== -1) {
                    productsInStock[productIndex].count += deletedItem.quantity;
                    updateProductsInWarehouse();
                    
                    // Add to stock history
                    stockHistory.push({
                        date: new Date().toISOString(),
                        productCode: deletedItem.code,
                        productName: deletedItem.name,
                        quantity: deletedItem.quantity,
                        type: 'return',
                        notes: `حذف من الفاتورة ${invoiceNumberInput.value}`,
                        user: adminNameDisplay.textContent
                    });
                }
                
                // Remove from invoice
                invoiceItems.splice(index, 1);
                
                // Render table
                renderInvoiceTable();
                
                // Show success message
                showToast('تم حذف المنتج من الفاتورة بنجاح');
            }
            
            // Apply invoice discount
            function applyInvoiceDiscount() {
                const type = invoiceDiscountType.value;
                const value = parseFloat(invoiceDiscountValue.value) || 0;
                const reason = invoiceDiscountReason.value.trim();
                
                if (value <= 0) {
                    showToast('قيمة الخصم يجب أن تكون أكبر من الصفر', 'error');
                    return;
                }
                
                invoiceDiscount = { type, value, reason };
                discountModal.style.display = 'none';
                
                // Render table to update total
                renderInvoiceTable();
                
                // Show success message
                showToast('تم تطبيق الخصم على الفاتورة بنجاح');
            }
            
            // Save invoice
            function saveInvoice() {
                if (invoiceItems.length === 0) {
                    showToast('لا توجد منتجات في الفاتورة', 'error');
                    return;
                }
                
                const invoiceNo = invoiceNumberInput.value.trim();
                if (!invoiceNo) {
                    showToast('الرجاء إدخال رقم الفاتورة', 'error');
                    return;
                }
                
                // Calculate total before discount
                let subtotal = invoiceItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                
                // Calculate total after discount
                let total = subtotal;
                if (invoiceDiscount.value > 0) {
                    if (invoiceDiscount.type === 'percentage') {
                        total = subtotal * (1 - (invoiceDiscount.value / 100));
                    } else {
                        total = subtotal - invoiceDiscount.value;
                    }
                }
                
                // Create invoice object
                const newInvoice = {
                    invoiceNumber: invoiceNo,
                    date: currentDateDisplay.textContent,
                    shop: shopNameInput.value,
                    admin: adminNameDisplay.textContent,
                    customer: customerNameInput.value || 'غير محدد',
                    paymentMethod: paymentMethodSelect.value,
                    items: [...invoiceItems],
                    subtotal: subtotal.toFixed(2),
                    discount: invoiceDiscount,
                    totalAmount: total.toFixed(2),
                    status: 'completed',
                    createdAt: new Date().toISOString()
                };
                
                // Save to invoices array
                invoices.push(newInvoice);
                
                // If payment method is not cash, create a debt
                if (paymentMethodSelect.value !== 'cash') {
                    const newDebt = {
                        id: Date.now().toString(),
                        customer: customerNameInput.value || 'غير محدد',
                        invoiceNumber: invoiceNo,
                        totalAmount: total,
                        paidAmount: 0,
                        remainingAmount: total,
                        dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(), // 30 days from now
                        status: 'unpaid',
                        createdAt: new Date().toISOString(),
                        payments: []
                    };
                    
                    debts.push(newDebt);
                }
                
                // Save data
                saveData();
                
                // Show success message
                showToast(`تم حفظ الفاتورة رقم ${invoiceNo} بنجاح`);
                
                // Reset form for new invoice
                resetForNewInvoice();
            }
            
            // Reset form for new invoice
            function resetForNewInvoice() {
                invoiceItems = [];
                invoiceDiscount = { type: 'fixed', value: 0, reason: '' };
                renderInvoiceTable();
                
                // Increment invoice number
                const currentInvoiceNo = parseInt(invoiceNumberInput.value);
                invoiceNumberInput.value = currentInvoiceNo + 1;
                
                // Clear customer name
                customerNameInput.value = '';
                
                // Focus on product code input
                itemCodeInput.focus();
            }
            
            // Search invoice
            function searchInvoice() {
                const searchNum = searchInvoiceInput.value.trim();
                if (!searchNum) {
                    showToast('الرجاء إدخال رقم الفاتورة', 'error');
                    return;
                }
                
                const foundInvoice = invoices.find(inv => inv.invoiceNumber === searchNum);
                
                if (foundInvoice) {
                    // Show invoice details in modal
                    showInvoiceModal(foundInvoice);
                } else {
                    showToast(`لم يتم العثور على فاتورة برقم ${searchNum}`, 'error');
                }
                
                searchInvoiceInput.value = '';
            }
            
            // Show invoice in modal
            function showInvoiceModal(invoice) {
                currentViewingInvoice = invoice;
                
                // Set invoice info
                document.getElementById('invoiceModalNumber').textContent = invoice.invoiceNumber;
                document.getElementById('invoiceModalShop').textContent = invoice.shop;
                document.getElementById('invoiceModalDate').textContent = invoice.date;
                document.getElementById('invoiceModalCustomer').textContent = invoice.customer;
                document.getElementById('invoiceModalPayment').textContent = getPaymentMethodName(invoice.paymentMethod);
                
                // Clear and populate items table
                viewInvoiceTableBody.innerHTML = '';
                invoice.items.forEach((item, index) => {
                    const row = viewInvoiceTableBody.insertRow();
                    const itemTotal = (item.price * item.quantity) - item.discount;
                    
                    // Row number
                    const rowNumberCell = row.insertCell();
                    rowNumberCell.textContent = index + 1;
                    
                    // Product name
                    const nameCell = row.insertCell();
                    nameCell.textContent = `${item.name} (${item.unit})`;
                    
                    // Quantity
                    const quantityCell = row.insertCell();
                    quantityCell.textContent = item.quantity;
                    
                    // Price
                    const priceCell = row.insertCell();
                    priceCell.textContent = item.price.toLocaleString();
                    
                    // Discount
                    const discountCell = row.insertCell();
                    discountCell.textContent = item.discount.toLocaleString();
                    
                    // Total
                    const totalCell = row.insertCell();
                    totalCell.textContent = itemTotal.toLocaleString();
                });
                
                // Set totals
                document.getElementById('invoiceModalSubtotal').textContent = invoice.subtotal.toLocaleString();
                
                let discountText = '0.00';
                if (invoice.discount.value > 0) {
                    if (invoice.discount.type === 'percentage') {
                        discountText = `${invoice.discount.value}% (${(invoice.subtotal * invoice.discount.value / 100).toLocaleString()})`;
                    } else {
                        discountText = invoice.discount.value.toLocaleString();
                    }
                }
                document.getElementById('invoiceModalDiscount').textContent = discountText;
                
                document.getElementById('invoiceModalTotal').textContent = invoice.totalAmount.toLocaleString();
                
                // Show modal
                viewInvoiceModal.style.display = 'flex';
            }
            
            // Print current invoice in modal
            function printCurrentInvoice() {
                if (!currentViewingInvoice) return;
                
                // In a real app, this would open a print dialog with a nicely formatted invoice
                alert(`سيتم طباعة الفاتورة رقم ${currentViewingInvoice.invoiceNumber} في التطبيق الكامل`);
            }
            
            // Clear invoice
            function clearInvoice() {
                if (invoiceItems.length === 0) {
                    showToast('لا توجد منتجات في الفاتورة', 'error');
                    return;
                }
                
                if (!confirm('هل أنت متأكد من تفريغ الفاتورة الحالية؟ سيتم فقدان جميع البيانات.')) return;
                
                // Return all items to stock
                invoiceItems.forEach(item => {
                    const productIndex = productsInStock.findIndex(p => p.code === item.code);
                    if (productIndex !== -1) {
                        productsInStock[productIndex].count += item.quantity;
                        
                        // Add to stock history
                        stockHistory.push({
                            date: new Date().toISOString(),
                            productCode: item.code,
                            productName: item.name,
                            quantity: item.quantity,
                            type: 'return',
                            notes: `إلغاء الفاتورة ${invoiceNumberInput.value}`,
                            user: adminNameDisplay.textContent
                        });
                    }
                });
                
                updateProductsInWarehouse();
                
                // Reset invoice
                invoiceItems = [];
                invoiceDiscount = { type: 'fixed', value: 0, reason: '' };
                renderInvoiceTable();
                
                showToast('تم تفريغ الفاتورة بنجاح');
            }
            
            // Print invoice
            function printInvoice() {
                if (invoiceItems.length === 0) {
                    showToast('لا توجد منتجات في الفاتورة للطباعة', 'error');
                    return;
                }
                
                // In a real app, this would open a print dialog with a nicely formatted invoice
                alert('سيتم فتح نافذة الطباعة في التطبيق الكامل');
            }
            
            // Link invoice (placeholder)
            function linkInvoice() {
                // This would link the current invoice to another invoice or order
                showToast('تم ربط الفاتورة بنجاح');
            }
            
            // Send hand (placeholder)
            function sendHand() {
                // This would send the current invoice to another device or user
                showToast('تم إرسال اليد بنجاح');
            }
            
            // Return hand (placeholder)
            function returnHand() {
                // This would return a previously sent hand
                showToast('تم استرداد اليد بنجاح');
            }
            
            // Product Management Functions
            function renderProductsTable() {
                productsTableBody.innerHTML = '';
                
                productsInStock.forEach((product, index) => {
                    const row = productsTableBody.insertRow();
                    
                    // Product Code
                    const codeCell = row.insertCell();
                    codeCell.textContent = product.code;
                    
                    // Product Name
                    const nameCell = row.insertCell();
                    nameCell.textContent = product.name;
                    
                    // Product Price
                    const priceCell = row.insertCell();
                    priceCell.textContent = product.price.toLocaleString();
                    
                    // Product Quantity
                    const quantityCell = row.insertCell();
                    quantityCell.textContent = product.count;
                    
                    // Product Unit
                    const unitCell = row.insertCell();
                    unitCell.textContent = product.unit || 'وحدة';
                    
                    // Product Category
                    const categoryCell = row.insertCell();
                    categoryCell.textContent = product.category || 'غير مصنف';
                    
                    // Actions
                    const actionsCell = row.insertCell();
                    
                    // Edit button
                    const editBtn = document.createElement('button');
                    editBtn.className = 'action-btn edit-btn';
                    editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                    editBtn.title = 'تعديل';
                    editBtn.onclick = () => editProduct(index);
                    actionsCell.appendChild(editBtn);
                    
                    // Delete button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'action-btn delete-btn';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.title = 'حذف';
                    deleteBtn.onclick = () => deleteProduct(index);
                    actionsCell.appendChild(deleteBtn);
                });
            }
            
            function addProduct() {
                const code = productCodeInput.value.trim();
                const name = productNameInputPM.value.trim();
                const price = parseFloat(productPriceInput.value);
                const quantity = parseInt(productQuantityInput.value);
                const unit = productUnitInput.value.trim();
                const category = productCategoryInput.value.trim();
                const barcode = productBarcodeInput.value.trim();
                
                if (!code || !name || isNaN(price) || price <= 0 || isNaN(quantity) || quantity < 0) {
                    showToast('الرجاء إدخال بيانات المنتج بشكل صحيح', 'error');
                    return;
                }
                
                // Check if product code already exists
                const existingProduct = productsInStock.find(p => p.code === code);
                if (existingProduct) {
                    showToast('كود المنتج موجود بالفعل', 'error');
                    return;
                }
                
                // Add new product
                const newProduct = {
                    code,
                    name,
                    price,
                    count: quantity,
                    unit,
                    category,
                    barcode,
                    createdAt: new Date().toISOString()
                };
                
                productsInStock.push(newProduct);
                updateProductsInWarehouse();
                
                // Add to stock history
                stockHistory.push({
                    date: new Date().toISOString(),
                    productCode: code,
                    productName: name,
                    quantity: quantity,
                    type: 'purchase',
                    notes: 'إضافة منتج جديد',
                    user: adminNameDisplay.textContent
                });
                
                // Clear inputs
                productCodeInput.value = '';
                productNameInputPM.value = '';
                productPriceInput.value = '';
                productQuantityInput.value = '';
                productUnitInput.value = '';
                productCategoryInput.value = '';
                productBarcodeInput.value = '';
                
                // Render table
                renderProductsTable();
                
                // Show success message
                showToast('تم إضافة المنتج بنجاح');
            }
            
            function editProduct(index) {
                const product = productsInStock[index];
                currentEditingProductIndex = index;
                
                productCodeInput.value = product.code;
                productNameInputPM.value = product.name;
                productPriceInput.value = product.price;
                productQuantityInput.value = product.count;
                productUnitInput.value = product.unit || '';
                productCategoryInput.value = product.category || '';
                productBarcodeInput.value = product.barcode || '';
                
                addProductBtn.style.display = 'none';
                updateProductBtn.style.display = 'inline-flex';
                cancelEditProductBtn.style.display = 'inline-flex';
                
                productCodeInput.focus();
            }
            
            function updateProduct() {
                if (currentEditingProductIndex === -1) return;
                
                const code = productCodeInput.value.trim();
                const name = productNameInputPM.value.trim();
                const price = parseFloat(productPriceInput.value);
                const quantity = parseInt(productQuantityInput.value);
                const unit = productUnitInput.value.trim();
                const category = productCategoryInput.value.trim();
                const barcode = productBarcodeInput.value.trim();
                
                if (!code || !name || isNaN(price) || price <= 0 || isNaN(quantity) || quantity < 0) {
                    showToast('الرجاء إدخال بيانات المنتج بشكل صحيح', 'error');
                    return;
                }
                
                // Update product
                productsInStock[currentEditingProductIndex] = {
                    ...productsInStock[currentEditingProductIndex],
                    code,
                    name,
                    price,
                    count: quantity,
                    unit,
                    category,
                    barcode
                };
                
                updateProductsInWarehouse();
                
                // Reset form
                cancelEditProduct();
                
                // Render table
                renderProductsTable();
                
                // Show success message
                showToast('تم تحديث المنتج بنجاح');
            }
            
            function cancelEditProduct() {
                currentEditingProductIndex = -1;
                
                productCodeInput.value = '';
                productNameInputPM.value = '';
                productPriceInput.value = '';
                productQuantityInput.value = '';
                productUnitInput.value = '';
                productCategoryInput.value = '';
                productBarcodeInput.value = '';
                
                addProductBtn.style.display = 'inline-flex';
                updateProductBtn.style.display = 'none';
                cancelEditProductBtn.style.display = 'none';
            }
            
            function deleteProduct(index) {
                if (!confirm('هل أنت متأكد من حذف هذا المنتج؟')) return;
                
                const deletedProduct = productsInStock[index];
                
                // Check if product is used in any invoice
                const isProductUsed = invoices.some(invoice => 
                    invoice.items.some(item => item.code === deletedProduct.code)
                );
                
                if (isProductUsed) {
                    showToast('لا يمكن حذف المنتج لأنه مستخدم في فواتير سابقة', 'error');
                    return;
                }
                
                productsInStock.splice(index, 1);
                updateProductsInWarehouse();
                renderProductsTable();
                
                showToast('تم حذف المنتج بنجاح');
            }
            
            // Warehouse Management Functions
            function renderWarehouseTable() {
                warehouseTableBody.innerHTML = '';
                
                productsInStock.forEach((product, index) => {
                    const row = warehouseTableBody.insertRow();
                    
                    // Product Code
                    const codeCell = row.insertCell();
                    codeCell.textContent = product.code;
                    
                    // Product Name
                    const nameCell = row.insertCell();
                    nameCell.textContent = product.name;
                    
                    // Product Price
                    const priceCell = row.insertCell();
                    priceCell.textContent = product.price.toLocaleString();
                    
                    // Product Quantity
                    const quantityCell = row.insertCell();
                    quantityCell.textContent = product.count;
                    
                    // Product Unit
                    const unitCell = row.insertCell();
                    unitCell.textContent = product.unit || 'وحدة';
                    
                    // Product Category
                    const categoryCell = row.insertCell();
                    categoryCell.textContent = product.category || 'غير مصنف';
                    
                    // Actions
                    const actionsCell = row.insertCell();
                    
                    // Add stock button
                    const addBtn = document.createElement('button');
                    addBtn.className = 'action-btn edit-btn';
                    addBtn.innerHTML = '<i class="fas fa-plus"></i>';
                    addBtn.title = 'إضافة مخزون';
                    addBtn.onclick = () => prepareAddStock(index);
                    actionsCell.appendChild(addBtn);
                });
            }
            
            function prepareAddStock(index) {
                const product = productsInStock[index];
                
                // Switch to add stock tab
                document.querySelector('#warehouseManagement .tab[data-tab="addStock"]').click();
                
                // Fill product info
                warehouseProductCode.value = product.code;
                warehouseProductName.value = product.name;
                warehouseCurrentStock.value = `${product.count} ${product.unit || 'وحدة'}`;
                warehouseAddQuantity.value = '1';
                warehouseAddReason.value = 'purchase';
                warehouseAddNotes.value = '';
                
                warehouseAddQuantity.focus();
            }
            
            function addStock() {
                const code = warehouseProductCode.value.trim();
                const quantity = parseInt(warehouseAddQuantity.value);
                const reason = warehouseAddReason.value;
                const notes = warehouseAddNotes.value.trim();
                
                if (!code || isNaN(quantity) || quantity <= 0) {
                    showToast('الرجاء إدخال كمية صحيحة', 'error');
                    return;
                }
                
                const productIndex = productsInStock.findIndex(p => p.code === code);
                if (productIndex === -1) {
                    showToast('المنتج غير موجود', 'error');
                    return;
                }
                
                // Update product quantity
                productsInStock[productIndex].count += quantity;
                updateProductsInWarehouse();
                
                // Add to stock history
                stockHistory.push({
                    date: new Date().toISOString(),
                    productCode: code,
                    productName: productsInStock[productIndex].name,
                    quantity: quantity,
                    type: reason,
                    notes: notes || `إضافة مخزون ${getStockReasonName(reason)}`,
                    user: adminNameDisplay.textContent
                });
                
                // Clear form
                warehouseProductCode.value = '';
                warehouseProductName.value = '';
                warehouseCurrentStock.value = '';
                warehouseAddQuantity.value = '1';
                warehouseAddNotes.value = '';
                
                // Render tables
                renderWarehouseTable();
                renderProductsTable();
                
                // Show success message
                showToast('تم إضافة المخزون بنجاح');
                
                // Switch back to stock tab
                document.querySelector('#warehouseManagement .tab[data-tab="stock"]').click();
            }
            
            function getStockReasonName(reason) {
                const reasons = {
                    'purchase': 'شراء جديد',
                    'return': 'مرتجع',
                    'adjustment': 'تعديل مخزون',
                    'other': 'أخرى'
                };
                return reasons[reason] || reason;
            }
            
            function applyStockHistoryFilter() {
                const filter = document.getElementById('stockHistoryFilter').value;
                const productCode = document.getElementById('stockHistoryProductCode').value.trim();
                
                let filteredHistory = [...stockHistory];
                
                if (filter === 'today') {
                    const today = new Date().toISOString().split('T')[0];
                    filteredHistory = filteredHistory.filter(item => item.date.includes(today));
                } else if (filter === 'week') {
                    const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    filteredHistory = filteredHistory.filter(item => new Date(item.date) >= oneWeekAgo);
                } else if (filter === 'month') {
                    const oneMonthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                    filteredHistory = filteredHistory.filter(item => new Date(item.date) >= oneMonthAgo);
                } else if (filter === 'product' && productCode) {
                    filteredHistory = filteredHistory.filter(item => item.productCode === productCode);
                }
                
                renderStockHistoryTable(filteredHistory);
            }
            
            function renderStockHistoryTable(history = stockHistory) {
                stockHistoryTableBody.innerHTML = '';
                
                history.forEach(item => {
                    const row = stockHistoryTableBody.insertRow();
                    
                    // Date
                    const dateCell = row.insertCell();
                    dateCell.textContent = new Date(item.date).toLocaleString();
                    
                    // Product Code
                    const codeCell = row.insertCell();
                    codeCell.textContent = item.productCode;
                    
                    // Product Name
                    const nameCell = row.insertCell();
                    nameCell.textContent = item.productName;
                    
                    // Quantity
                    const quantityCell = row.insertCell();
                    quantityCell.textContent = item.quantity > 0 ? `+${item.quantity}` : item.quantity;
                    quantityCell.style.color = item.quantity > 0 ? 'green' : 'red';
                    
                    // Type
                    const typeCell = row.insertCell();
                    typeCell.textContent = getStockTypeName(item.type);
                    
                    // User
                    const userCell = row.insertCell();
                    userCell.textContent = item.user;
                });
            }
            
            function getStockTypeName(type) {
                const types = {
                    'purchase': 'شراء',
                    'sale': 'بيع',
                    'return': 'مرتجع',
                    'adjustment': 'تعديل',
                    'other': 'أخرى'
                };
                return types[type] || type;
            }
            
            // Invoices Management Functions
            function renderInvoicesTable(filteredInvoices = invoices) {
                invoicesTableBody.innerHTML = '';
                
                filteredInvoices.forEach(invoice => {
                    const row = invoicesTableBody.insertRow();
                    
                    // Invoice Number
                    const numberCell = row.insertCell();
                    numberCell.textContent = invoice.invoiceNumber;
                    
                    // Date
                    const dateCell = row.insertCell();
                    dateCell.textContent = invoice.date;
                    
                    // Customer
                    const customerCell = row.insertCell();
                    customerCell.textContent = invoice.customer;
                    
                    // Items Count
                    const countCell = row.insertCell();
                    countCell.textContent = invoice.items.length;
                    
                    // Total Amount
                    const totalCell = row.insertCell();
                    totalCell.textContent = invoice.totalAmount.toLocaleString();
                    
                    // Payment Method
                    const paymentCell = row.insertCell();
                    paymentCell.textContent = getPaymentMethodName(invoice.paymentMethod);
                    
                    // Actions
                    const actionsCell = row.insertCell();
                    
                    // View button
                    const viewBtn = document.createElement('button');
                    viewBtn.className = 'action-btn edit-btn';
                    viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
                    viewBtn.title = 'عرض';
                    viewBtn.onclick = () => showInvoiceModal(invoice);
                    actionsCell.appendChild(viewBtn);
                    
                    // Return button (only for completed invoices)
                    if (invoice.status === 'completed') {
                        const returnBtn = document.createElement('button');
                        returnBtn.className = 'action-btn delete-btn';
                        returnBtn.innerHTML = '<i class="fas fa-undo"></i>';
                        returnBtn.title = 'إرجاع';
                        returnBtn.onclick = () => prepareReturnInvoice(invoice);
                        actionsCell.appendChild(returnBtn);
                    }
                });
            }
            
            function renderTodayInvoicesTable() {
                const today = new Date().toISOString().split('T')[0];
                const todayInvoices = invoices.filter(invoice => {
                    return invoice.date.includes(today) && invoice.status === 'completed';
                });
                
                todayInvoicesTableBody.innerHTML = '';
                
                todayInvoices.forEach(invoice => {
                    const row = todayInvoicesTableBody.insertRow();
                    
                    // Invoice Number
                    const numberCell = row.insertCell();
                    numberCell.textContent = invoice.invoiceNumber;
                    
                    // Time
                    const timeCell = row.insertCell();
                    timeCell.textContent = invoice.date.split(' ')[1] || '';
                    
                    // Customer
                    const customerCell = row.insertCell();
                    customerCell.textContent = invoice.customer;
                    
                    // Items Count
                    const countCell = row.insertCell();
                    countCell.textContent = invoice.items.length;
                    
                    // Total Amount
                    const totalCell = row.insertCell();
                    totalCell.textContent = invoice.totalAmount.toLocaleString();
                    
                    // Payment Method
                    const paymentCell = row.insertCell();
                    paymentCell.textContent = getPaymentMethodName(invoice.paymentMethod);
                    
                    // Actions
                    const actionsCell = row.insertCell();
                    
                    // View button
                    const viewBtn = document.createElement('button');
                    viewBtn.className = 'action-btn edit-btn';
                    viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
                    viewBtn.title = 'عرض';
                    viewBtn.onclick = () => showInvoiceModal(invoice);
                    actionsCell.appendChild(viewBtn);
                });
            }
            
            function renderReturnedInvoicesTable() {
                const returnedInvoices = invoices.filter(invoice => invoice.status === 'returned');
                
                returnedInvoicesTableBody.innerHTML = '';
                
                returnedInvoices.forEach(invoice => {
                    const row = returnedInvoicesTableBody.insertRow();
                    
                    // Invoice Number
                    const numberCell = row.insertCell();
                    numberCell.textContent = invoice.invoiceNumber;
                    
                    // Return Date
                    const dateCell = row.insertCell();
                    dateCell.textContent = invoice.returnDate || '';
                    
                    // Customer
                    const customerCell = row.insertCell();
                    customerCell.textContent = invoice.customer;
                    
                    // Items Count
                    const countCell = row.insertCell();
                    countCell.textContent = invoice.items.length;
                    
                    // Total Amount
                    const totalCell = row.insertCell();
                    totalCell.textContent = invoice.returnAmount?.toLocaleString() || '0';
                    
                    // Return Reason
                    const reasonCell = row.insertCell();
                    reasonCell.textContent = invoice.returnReason || '';
                    
                    // Actions
                    const actionsCell = row.insertCell();
                    
                    // View button
                    const viewBtn = document.createElement('button');
                    viewBtn.className = 'action-btn edit-btn';
                    viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
                    viewBtn.title = 'عرض';
                    viewBtn.onclick = () => showInvoiceModal(invoice);
                    actionsCell.appendChild(viewBtn);
                });
            }
            
            function getPaymentMethodName(method) {
                const methods = {
                    'cash': 'كاش',
                    'card': 'بطاقة',
                    'bank': 'تحويل بنكي'
                };
                return methods[method] || method;
            }
            
            function applyInvoiceFilter() {
                const dateFrom = document.getElementById('invoiceFilterDateFrom').value;
                const dateTo = document.getElementById('invoiceFilterDateTo').value;
                const customer = document.getElementById('invoiceFilterCustomer').value.trim().toLowerCase();
                const paymentMethod = document.getElementById('invoiceFilterPayment').value;
                
                let filteredInvoices = [...invoices];
                
                if (dateFrom) {
                    filteredInvoices = filteredInvoices.filter(invoice => {
                        return invoice.date >= dateFrom;
                    });
                }
                
                if (dateTo) {
                    filteredInvoices = filteredInvoices.filter(invoice => {
                        return invoice.date <= dateTo;
                    });
                }
                
                if (customer) {
                    filteredInvoices = filteredInvoices.filter(invoice => {
                        return invoice.customer.toLowerCase().includes(customer);
                    });
                }
                
                if (paymentMethod !== 'all') {
                    filteredInvoices = filteredInvoices.filter(invoice => {
                        return invoice.paymentMethod === paymentMethod;
                    });
                }
                
                renderInvoicesTable(filteredInvoices);
            }
            
            function resetInvoiceFilter() {
                document.getElementById('invoiceFilterDateFrom').value = '';
                document.getElementById('invoiceFilterDateTo').value = '';
                document.getElementById('invoiceFilterCustomer').value = '';
                document.getElementById('invoiceFilterPayment').value = 'all';
                
                renderInvoicesTable();
            }
            
            function prepareReturnInvoice(invoice) {
                currentViewingInvoice = invoice;
                
                // Set invoice info
                document.getElementById('returnInvoiceModalNumber').textContent = invoice.invoiceNumber;
                document.getElementById('returnInvoiceModalShop').textContent = invoice.shop;
                document.getElementById('returnInvoiceModalDate').textContent = invoice.date;
                document.getElementById('returnInvoiceModalCustomer').textContent = invoice.customer;
                document.getElementById('returnInvoiceModalTotal').textContent = invoice.totalAmount.toLocaleString();
                
                // Clear and populate items table
                returnInvoiceTableBody.innerHTML = '';
                invoice.items.forEach((item, index) => {
                    const row = returnInvoiceTableBody.insertRow();
                    
                    // Checkbox
                    const checkCell = row.insertCell();
                    const checkBox = document.createElement('input');
                    checkBox.type = 'checkbox';
                    checkBox.checked = true;
                    checkBox.dataset.index = index;
                    checkBox.addEventListener('change', updateReturnAmount);
                    checkCell.appendChild(checkBox);
                    
                    // Product name
                    const nameCell = row.insertCell();
                    nameCell.textContent = `${item.name} (${item.unit})`;
                    
                    // Sold quantity
                    const soldQtyCell = row.insertCell();
                    soldQtyCell.textContent = item.quantity;
                    
                    // Return quantity
                    const returnQtyCell = row.insertCell();
                    const returnQtyInput = document.createElement('input');
                    returnQtyInput.type = 'number';
                    returnQtyInput.min = '0';
                    returnQtyInput.max = item.quantity;
                    returnQtyInput.value = item.quantity;
                    returnQtyInput.dataset.index = index;
                    returnQtyInput.addEventListener('input', updateReturnAmount);
                    returnQtyCell.appendChild(returnQtyInput);
                    
                    // Return amount
                    const amountCell = row.insertCell();
                    amountCell.textContent = ((item.price * item.quantity) - item.discount).toLocaleString();
                    amountCell.dataset.amount = (item.price * item.quantity) - item.discount;
                });
                
                // Set initial return amount
                updateReturnAmount();
                
                // Show modal
                returnInvoiceModal.style.display = 'flex';
            }
            
            function updateReturnAmount() {
                let totalReturnAmount = 0;
                
                // Get all checked items
                const checkBoxes = returnInvoiceTableBody.querySelectorAll('input[type="checkbox"]:checked');
                
                checkBoxes.forEach(checkBox => {
                    const index = checkBox.dataset.index;
                    const returnQtyInput = returnInvoiceTableBody.querySelector(`input[data-index="${index}"]`);
                    const amountCell = returnInvoiceTableBody.querySelector(`td[data-amount][data-index="${index}"]`);
                    
                    if (returnQtyInput && amountCell) {
                        const returnQty = parseInt(returnQtyInput.value);
                        const itemAmount = parseFloat(amountCell.dataset.amount);
                        const itemPrice = itemAmount / parseInt(returnQtyInput.max);
                        
                        totalReturnAmount += itemPrice * returnQty;
                    }
                });
                
                document.getElementById('returnInvoiceAmount').textContent = totalReturnAmount.toLocaleString();
            }
            
            function confirmReturnInvoice() {
                if (!currentViewingInvoice) return;
                
                const returnReason = document.getElementById('returnReason').value;
                const otherReason = document.getElementById('returnOtherReason').value.trim();
                const finalReason = returnReason === 'other' ? otherReason : returnReason;
                
                if (!finalReason) {
                    showToast('الرجاء إدخال سبب الإرجاع', 'error');
                    return;
                }
                
                // Calculate return amount and items
                let returnAmount = 0;
                const returnItems = [];
                
                const checkBoxes = returnInvoiceTableBody.querySelectorAll('input[type="checkbox"]:checked');
                checkBoxes.forEach(checkBox => {
                    const index = checkBox.dataset.index;
                    const returnQtyInput = returnInvoiceTableBody.querySelector(`input[data-index="${index}"]`);
                    const amountCell = returnInvoiceTableBody.querySelector(`td[data-amount][data-index="${index}"]`);
                    
                    if (returnQtyInput && amountCell) {
                        const returnQty = parseInt(returnQtyInput.value);
                        const itemAmount = parseFloat(amountCell.dataset.amount);
                        const itemPrice = itemAmount / parseInt(returnQtyInput.max);
                        
                        returnAmount += itemPrice * returnQty;
                        
                        // Add to return items
                        const originalItem = currentViewingInvoice.items[index];
                        returnItems.push({
                            ...originalItem,
                            quantity: returnQty,
                            returnAmount: itemPrice * returnQty
                        });
                        
                        // Return quantity to stock
                        const productIndex = productsInStock.findIndex(p => p.code === originalItem.code);
                        if (productIndex !== -1) {
                            productsInStock[productIndex].count += returnQty;
                            
                            // Add to stock history
                            stockHistory.push({
                                date: new Date().toISOString(),
                                productCode: originalItem.code,
                                productName: originalItem.name,
                                quantity: returnQty,
                                type: 'return',
                                notes: `إرجاع من الفاتورة ${currentViewingInvoice.invoiceNumber}`,
                                user: adminNameDisplay.textContent
                            });
                        }
                    }
                });
                
                if (returnItems.length === 0) {
                    showToast('الرجاء تحديد منتجات للإرجاع', 'error');
                    return;
                }
                
                // Mark original invoice as returned
                const invoiceIndex = invoices.findIndex(inv => inv.invoiceNumber === currentViewingInvoice.invoiceNumber);
                if (invoiceIndex !== -1) {
                    invoices[invoiceIndex] = {
                        ...invoices[invoiceIndex],
                        status: 'returned',
                        returnDate: new Date().toISOString(),
                        returnReason: finalReason,
                        returnAmount: returnAmount,
                        returnItems: returnItems
                    };
                }
                
                // If there was a debt for this invoice, update it
                const debtIndex = debts.findIndex(d => d.invoiceNumber === currentViewingInvoice.invoiceNumber);
                if (debtIndex !== -1) {
                    debts[debtIndex].remainingAmount -= returnAmount;
                    if (debts[debtIndex].remainingAmount <= 0) {
                        debts[debtIndex].status = 'paid';
                    }
                    
                    // Add payment record
                    debts[debtIndex].payments.push({
                        date: new Date().toISOString(),
                        amount: returnAmount,
                        method: 'return',
                        notes: `إرجاع فاتورة ${currentViewingInvoice.invoiceNumber}`,
                        user: adminNameDisplay.textContent
                    });
                }
                
                // Save data
                saveData();
                
                // Close modal
                returnInvoiceModal.style.display = 'none';
                
                // Show success message
                showToast(`تم إرجاع الفاتورة رقم ${currentViewingInvoice.invoiceNumber} بنجاح`);
                
                // Refresh tables
                renderInvoicesTable();
                renderProductsTable();
                if (debtIndex !== -1) {
                    renderDebtsTable();
                }
            }
            
            // Debts Management Functions
            function renderDebtsTable(filteredDebts = debts) {
                debtsTableBody.innerHTML = '';
                
                filteredDebts.forEach(debt => {
                    const row = debtsTableBody.insertRow();
                    
                    // Customer Name
                    const customerCell = row.insertCell();
                    customerCell.textContent = debt.customer;
                    
                    // Invoice Number
                    const invoiceCell = row.insertCell();
                    invoiceCell.textContent = debt.invoiceNumber || '--';
                    
                    // Total Amount
                    const totalCell = row.insertCell();
                    totalCell.textContent = debt.totalAmount.toLocaleString();
                    
                    // Paid Amount
                    const paidCell = row.insertCell();
                    paidCell.textContent = debt.paidAmount.toLocaleString();
                    
                    // Remaining Amount
                    const remainingCell = row.insertCell();
                    remainingCell.textContent = debt.remainingAmount.toLocaleString();
                    
                    // Due Date
                    const dueCell = row.insertCell();
                    dueCell.textContent = new Date(debt.dueDate).toLocaleDateString();
                    
                    // Status
                    const statusCell = row.insertCell();
                    statusCell.textContent = getDebtStatusName(debt.status);
                    statusCell.style.color = getDebtStatusColor(debt.status);
                    
                    // Actions
                    const actionsCell = row.insertCell();
                    
                    // View button
                    const viewBtn = document.createElement('button');
                    viewBtn.className = 'action-btn edit-btn';
                    viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
                    viewBtn.title = 'عرض';
                    viewBtn.onclick = () => viewDebt(debt);
                    actionsCell.appendChild(viewBtn);
                    
                    // Add payment button
                    if (debt.remainingAmount > 0) {
                        const paymentBtn = document.createElement('button');
                        paymentBtn.className = 'action-btn success';
                        paymentBtn.innerHTML = '<i class="fas fa-money-bill-wave"></i>';
                        paymentBtn.title = 'إضافة سداد';
                        paymentBtn.onclick = () => prepareAddPayment(debt);
                        actionsCell.appendChild(paymentBtn);
                    }
                });
            }
            
            function getDebtStatusName(status) {
                const statuses = {
                    'paid': 'مسددة',
                    'unpaid': 'غير مسددة',
                    'overdue': 'متأخرة',
                    'partial': 'جزئي'
                };
                return statuses[status] || status;
            }
            
            function getDebtStatusColor(status) {
                const colors = {
                    'paid': 'green',
                    'unpaid': 'red',
                    'overdue': 'orange',
                    'partial': 'blue'
                };
                return colors[status] || 'black';
            }
            
            function applyDebtFilter() {
                const customer = document.getElementById('debtFilterCustomer').value.trim().toLowerCase();
                const status = document.getElementById('debtFilterStatus').value;
                
                let filteredDebts = [...debts];
                
                if (customer) {
                    filteredDebts = filteredDebts.filter(debt => {
                        return debt.customer.toLowerCase().includes(customer);
                    });
                }
                
                if (status !== 'all') {
                    filteredDebts = filteredDebts.filter(debt => {
                        if (status === 'paid') return debt.status === 'paid';
                        if (status === 'unpaid') return debt.status === 'unpaid';
                        if (status === 'overdue') {
                            return debt.status === 'unpaid' && new Date(debt.dueDate) < new Date();
                        }
                        return true;
                    });
                }
                
                renderDebtsTable(filteredDebts);
            }
            
            function viewDebt(debt) {
                // In a real app, this would show debt details in a modal
                alert(`عرض تفاصيل الدين للعميل: ${debt.customer}\nرقم الفاتورة: ${debt.invoiceNumber || '--'}\nالمبلغ الإجمالي: ${debt.totalAmount}\nالمسدد: ${debt.paidAmount}\nالمتبقي: ${debt.remainingAmount}\nتاريخ الاستحقاق: ${new Date(debt.dueDate).toLocaleDateString()}`);
            }
            
            function prepareAddPayment(debt) {
                currentEditingDebt = debt;
                
                // Fill payment form
                document.getElementById('paymentCustomerName').value = debt.customer;
                document.getElementById('paymentInvoiceNumber').value = debt.invoiceNumber || '';
                document.getElementById('paymentRemainingAmount').value = debt.remainingAmount.toLocaleString();
                document.getElementById('paymentAmount').value = '';
                document.getElementById('paymentMethod').value = 'cash';
                document.getElementById('paymentNotes').value = '';
                
                // Show modal
                addPaymentModal.style.display = 'flex';
                document.getElementById('paymentAmount').focus();
            }
            
            function savePayment() {
                if (!currentEditingDebt) return;
                
                const amount = parseFloat(document.getElementById('paymentAmount').value);
                const method = document.getElementById('paymentMethod').value;
                const notes = document.getElementById('paymentNotes').value.trim();
                
                if (isNaN(amount) || amount <= 0) {
                    showToast('الرجاء إدخال مبلغ صحيح', 'error');
                    return;
                }
                
                if (amount > currentEditingDebt.remainingAmount) {
                    showToast('المبلغ المدخل أكبر من المبلغ المتبقي', 'error');
                    return;
                }
                
                // Find debt in array
                const debtIndex = debts.findIndex(d => d.id === currentEditingDebt.id);
                if (debtIndex === -1) {
                    showToast('حدث خطأ، لم يتم العثور على الدين', 'error');
                    return;
                }
                
                // Update debt
                debts[debtIndex].paidAmount += amount;
                debts[debtIndex].remainingAmount -= amount;
                
                if (debts[debtIndex].remainingAmount <= 0) {
                    debts[debtIndex].status = 'paid';
                } else if (new Date(debts[debtIndex].dueDate) < new Date()) {
                    debts[debtIndex].status = 'overdue';
                } else {
                    debts[debtIndex].status = 'partial';
                }
                
                // Add payment record
                debts[debtIndex].payments.push({
                    date: new Date().toISOString(),
                    amount: amount,
                    method: method,
                    notes: notes || `سداد للفاتورة ${debts[debtIndex].invoiceNumber || ''}`,
                    user: adminNameDisplay.textContent
                });
                
                // Save data
                saveData();
                
                // Close modal
                addPaymentModal.style.display = 'none';
                
                // Show success message
                showToast('تم حفظ السداد بنجاح');
                
                // Refresh table
                renderDebtsTable();
            }
            
            function saveDebt() {
                const customer = document.getElementById('debtCustomerName').value.trim();
                const invoiceNumber = document.getElementById('debtInvoiceNumber').value.trim();
                const amount = parseFloat(document.getElementById('debtAmount').value);
                const dueDate = document.getElementById('debtDueDate').value;
                const notes = document.getElementById('debtNotes').value.trim();
                
                if (!customer || isNaN(amount) || amount <= 0 || !dueDate) {
                    showToast('الرجاء إدخال بيانات صحيحة', 'error');
                    return;
                }
                
                // Create new debt
                const newDebt = {
                    id: Date.now().toString(),
                    customer: customer,
                    invoiceNumber: invoiceNumber || null,
                    totalAmount: amount,
                    paidAmount: 0,
                    remainingAmount: amount,
                    dueDate: dueDate,
                    status: 'unpaid',
                    createdAt: new Date().toISOString(),
                    payments: [],
                    notes: notes
                };
                
                debts.push(newDebt);
                saveData();
                
                // Clear form
                document.getElementById('debtCustomerName').value = '';
                document.getElementById('debtInvoiceNumber').value = '';
                document.getElementById('debtAmount').value = '';
                document.getElementById('debtDueDate').valueAsDate = new Date();
                document.getElementById('debtNotes').value = '';
                
                // Show success message
                showToast('تم حفظ الدين بنجاح');
                
                // Refresh table
                renderDebtsTable();
                
                // Switch back to all debts tab
                document.querySelector('#debtsManagement .tab[data-tab="allDebts"]').click();
            }
            
            function applyPaymentFilter() {
                const customer = document.getElementById('paymentFilterCustomer').value.trim().toLowerCase();
                const dateFrom = document.getElementById('paymentFilterDateFrom').value;
                const dateTo = document.getElementById('paymentFilterDateTo').value;
                
                // Collect all payments from all debts
                let allPayments = [];
                debts.forEach(debt => {
                    debt.payments.forEach(payment => {
                        allPayments.push({
                            ...payment,
                            customer: debt.customer,
                            invoiceNumber: debt.invoiceNumber
                        });
                    });
                });
                
                // Apply filters
                if (customer) {
                    allPayments = allPayments.filter(payment => 
                        payment.customer.toLowerCase().includes(customer)
                    );
                }
                
                if (dateFrom) {
                    allPayments = allPayments.filter(payment => 
                        payment.date >= dateFrom
                    );
                }
                
                if (dateTo) {
                    allPayments = allPayments.filter(payment => 
                        payment.date <= dateTo
                    );
                }
                
                // Sort by date (newest first)
                allPayments.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Render table
                renderPaymentsTable(allPayments);
            }
            
            function renderPaymentsTable(payments) {
                debtPaymentsTableBody.innerHTML = '';
                
                payments.forEach(payment => {
                    const row = debtPaymentsTableBody.insertRow();
                    
                    // Date
                    const dateCell = row.insertCell();
                    dateCell.textContent = new Date(payment.date).toLocaleString();
                    
                    // Customer
                    const customerCell = row.insertCell();
                    customerCell.textContent = payment.customer;
                    
                    // Invoice Number
                    const invoiceCell = row.insertCell();
                    invoiceCell.textContent = payment.invoiceNumber || '--';
                    
                    // Amount
                    const amountCell = row.insertCell();
                    amountCell.textContent = payment.amount.toLocaleString();
                    
                    // Method
                    const methodCell = row.insertCell();
                    methodCell.textContent = getPaymentMethodName(payment.method);
                    
                    // Notes
                    const notesCell = row.insertCell();
                    notesCell.textContent = payment.notes || '--';
                });
            }
            
            // Reports Management Functions
            function generateSalesReport() {
                const reportType = document.getElementById('salesReportType').value;
                const dateFrom = document.getElementById('salesReportDateFrom').value;
                const dateTo = document.getElementById('salesReportDateTo').value;
                const paymentMethod = document.getElementById('salesReportPaymentMethod').value;
                
                let filteredInvoices = invoices.filter(invoice => invoice.status === 'completed');
                
                // Apply date filter based on report type
                if (reportType === 'today') {
                    const today = new Date().toISOString().split('T')[0];
                    filteredInvoices = filteredInvoices.filter(invoice => invoice.date.includes(today));
                } else if (reportType === 'weekly') {
                    const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    filteredInvoices = filteredInvoices.filter(invoice => new Date(invoice.date) >= oneWeekAgo);
                } else if (reportType === 'monthly') {
                    const oneMonthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                    filteredInvoices = filteredInvoices.filter(invoice => new Date(invoice.date) >= oneMonthAgo);
                } else if (reportType === 'yearly') {
                    const oneYearAgo = new Date(Date.now() - 365 * 24 * 60 * 60 * 1000);
                    filteredInvoices = filteredInvoices.filter(invoice => new Date(invoice.date) >= oneYearAgo);
                } else if (reportType === 'custom' && dateFrom && dateTo) {
                    filteredInvoices = filteredInvoices.filter(invoice => 
                        invoice.date >= dateFrom && invoice.date <= dateTo
                    );
                }
                
                // Apply payment method filter
                if (paymentMethod !== 'all') {
                    filteredInvoices = filteredInvoices.filter(invoice => 
                        invoice.paymentMethod === paymentMethod
                    );
                }
                
                // Group by period
                let reportData = [];
                
                if (reportType === 'daily' || reportType === 'today') {
                    // Group by day
                    const grouped = {};
                    filteredInvoices.forEach(invoice => {
                        const date = invoice.date.split(' ')[0];
                        if (!grouped[date]) {
                            grouped[date] = {
                                period: date,
                                count: 0,
                                total: 0,
                                discount: 0,
                                net: 0
                            };
                        }
                        
                        grouped[date].count++;
                        grouped[date].total += parseFloat(invoice.subtotal);
                        
                        let discountAmount = 0;
                        if (invoice.discount.value > 0) {
                            if (invoice.discount.type === 'percentage') {
                                discountAmount = parseFloat(invoice.subtotal) * invoice.discount.value / 100;
                            } else {
                                discountAmount = invoice.discount.value;
                            }
                        }
                        
                        grouped[date].discount += discountAmount;
                        grouped[date].net += parseFloat(invoice.totalAmount);
                    });
                    
                    reportData = Object.values(grouped);
                } else if (reportType === 'weekly') {
                    // Group by week
                    const grouped = {};
                    filteredInvoices.forEach(invoice => {
                        const date = new Date(invoice.date);
                        const weekStart = getWeekStartDate(date);
                        const weekKey = weekStart.toISOString().split('T')[0];
                        
                        if (!grouped[weekKey]) {
                            grouped[weekKey] = {
                                period: `الأسبوع ${weekStart.getDate()}/${weekStart.getMonth()+1}`,
                                count: 0,
                                total: 0,
                                discount: 0,
                                net: 0
                            };
                        }
                        
                        grouped[weekKey].count++;
                        grouped[weekKey].total += parseFloat(invoice.subtotal);
                        
                        let discountAmount = 0;
                        if (invoice.discount.value > 0) {
                            if (invoice.discount.type === 'percentage') {
                                discountAmount = parseFloat(invoice.subtotal) * invoice.discount.value / 100;
                            } else {
                                discountAmount = invoice.discount.value;
                            }
                        }
                        
                        grouped[weekKey].discount += discountAmount;
                        grouped[weekKey].net += parseFloat(invoice.totalAmount);
                    });
                    
                    reportData = Object.values(grouped);
                } else if (reportType === 'monthly') {
                    // Group by month
                    const grouped = {};
                    filteredInvoices.forEach(invoice => {
                        const date = new Date(invoice.date);
                        const monthKey = `${date.getFullYear()}-${date.getMonth()+1}`;
                        
                        if (!grouped[monthKey]) {
                            grouped[monthKey] = {
                                period: `الشهر ${date.getMonth()+1}`,
                                count: 0,
                                total: 0,
                                discount: 0,
                                net: 0
                            };
                        }
                        
                        grouped[monthKey].count++;
                        grouped[monthKey].total += parseFloat(invoice.subtotal);
                        
                        let discountAmount = 0;
                        if (invoice.discount.value > 0) {
                            if (invoice.discount.type === 'percentage') {
                                discountAmount = parseFloat(invoice.subtotal) * invoice.discount.value / 100;
                            } else {
                                discountAmount = invoice.discount.value;
                            }
                        }
                        
                        grouped[monthKey].discount += discountAmount;
                        grouped[monthKey].net += parseFloat(invoice.totalAmount);
                    });
                    
                    reportData = Object.values(grouped);
                } else {
                    // Single row for all data
                    const summary = {
                        period: 'الإجمالي',
                        count: filteredInvoices.length,
                        total: 0,
                        discount: 0,
                        net: 0
                    };
                    
                    filteredInvoices.forEach(invoice => {
                        summary.total += parseFloat(invoice.subtotal);
                        
                        let discountAmount = 0;
                        if (invoice.discount.value > 0) {
                            if (invoice.discount.type === 'percentage') {
                                discountAmount = parseFloat(invoice.subtotal) * invoice.discount.value / 100;
                            } else {
                                discountAmount = invoice.discount.value;
                            }
                        }
                        
                        summary.discount += discountAmount;
                        summary.net += parseFloat(invoice.totalAmount);
                    });
                    
                    reportData = [summary];
                }
                
                // Render report table
                renderSalesReportTable(reportData);
                
                // Update chart (in a real app, this would show a proper chart)
                document.getElementById('salesReportChart').innerHTML = `
                    <p>إجمالي الفواتير: ${reportData.reduce((sum, item) => sum + item.count, 0)}</p>
                    <p>إجمالي المبيعات: ${reportData.reduce((sum, item) => sum + item.net, 0).toLocaleString()} دينار</p>
                `;
            }
            
            function getWeekStartDate(date) {
                const day = date.getDay();
                const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Adjust for Sunday as first day
                return new Date(date.setDate(diff));
            }
            
            function renderSalesReportTable(data) {
                salesReportTableBody.innerHTML = '';
                
                data.forEach(item => {
                    const row = salesReportTableBody.insertRow();
                    
                    // Period
                    const periodCell = row.insertCell();
                    periodCell.textContent = item.period;
                    
                    // Invoices Count
                    const countCell = row.insertCell();
                    countCell.textContent = item.count;
                    
                    // Total Sales
                    const totalCell = row.insertCell();
                    totalCell.textContent = item.total.toLocaleString();
                    
                    // Total Discount
                    const discountCell = row.insertCell();
                    discountCell.textContent = item.discount.toLocaleString();
                    
                    // Net Sales
                    const netCell = row.insertCell();
                    netCell.textContent = item.net.toLocaleString();
                });
            }
            
            function generateProductsReport() {
                const reportType = document.getElementById('productsReportType').value;
                const category = document.getElementById('productsReportCategory').value;
                const period = document.getElementById('productsReportPeriod').value;
                
                let filteredInvoices = [...invoices];
                
                // Apply period filter
                if (period === 'today') {
                    const today = new Date().toISOString().split('T')[0];
                    filteredInvoices = filteredInvoices.filter(invoice => invoice.date.includes(today));
                } else if (period === 'week') {
                    const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    filteredInvoices = filteredInvoices.filter(invoice => new Date(invoice.date) >= oneWeekAgo);
                } else if (period === 'month') {
                    const oneMonthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                    filteredInvoices = filteredInvoices.filter(invoice => new Date(invoice.date) >= oneMonthAgo);
                }
                
                // Collect all sold products
                let soldProducts = {};
                
                filteredInvoices.forEach(invoice => {
                    invoice.items.forEach(item => {
                        if (!soldProducts[item.code]) {
                            const product = productsInStock.find(p => p.code === item.code) || {
                                name: item.name,
                                unit: item.unit,
                                category: 'غير معروف'
                            };
                            
                            soldProducts[item.code] = {
                                code: item.code,
                                name: item.name,
                                unit: item.unit,
                                category: product.category,
                                soldQuantity: 0,
                                totalSales: 0,
                                currentStock: product.count || 0
                            };
                        }
                        
                        soldProducts[item.code].soldQuantity += item.quantity;
                        soldProducts[item.code].totalSales += (item.price * item.quantity) - item.discount;
                    });
                });
                
                // Convert to array
                let reportData = Object.values(soldProducts);
                
                // Apply category filter
                if (reportType === 'byCategory' && category !== 'all') {
                    reportData = reportData.filter(item => item.category === category);
                }
                
                // Apply report type filter
                if (reportType === 'topSelling') {
                    reportData.sort((a, b) => b.soldQuantity - a.soldQuantity);
                } else if (reportType === 'lowStock') {
                    reportData = reportData.filter(item => item.currentStock <= 10); // Assuming 10 is low stock threshold
                    reportData.sort((a, b) => a.currentStock - b.currentStock);
                } else if (reportType === 'notSelling') {
                    const soldProductCodes = reportData.map(item => item.code);
                    reportData = productsInStock
                        .filter(product => !soldProductCodes.includes(product.code))
                        .map(product => ({
                            code: product.code,
                            name: product.name,
                            unit: product.unit,
                            category: product.category,
                            soldQuantity: 0,
                            totalSales: 0,
                            currentStock: product.count
                        }));
                }
                
                // Calculate sales percentage
                const totalSales = reportData.reduce((sum, item) => sum + item.totalSales, 0);
                reportData.forEach(item => {
                    item.salesPercentage = totalSales > 0 ? (item.totalSales / totalSales * 100) : 0;
                });
                
                // Render report table
                renderProductsReportTable(reportData);
                
                // Update chart (in a real app, this would show a proper chart)
                document.getElementById('productsReportChart').innerHTML = `
                    <p>عدد المنتجات: ${reportData.length}</p>
                    <p>إجمالي الكمية المباعة: ${reportData.reduce((sum, item) => sum + item.soldQuantity, 0)}</p>
                    <p>إجمالي المبيعات: ${totalSales.toLocaleString()} دينار</p>
                `;
            }
            
            function renderProductsReportTable(data) {
                productsReportTableBody.innerHTML = '';
                
                data.forEach((item, index) => {
                    const row = productsReportTableBody.insertRow();
                    
                    // #
                    const indexCell = row.insertCell();
                    indexCell.textContent = index + 1;
                    
                    // Product Name
                    const nameCell = row.insertCell();
                    nameCell.textContent = item.name;
                    
                    // Sold Quantity
                    const qtyCell = row.insertCell();
                    qtyCell.textContent = `${item.soldQuantity} ${item.unit}`;
                    
                    // Total Sales
                    const salesCell = row.insertCell();
                    salesCell.textContent = item.totalSales.toLocaleString();
                    
                    // Current Stock
                    const stockCell = row.insertCell();
                    stockCell.textContent = item.currentStock;
                    
                    // Sales Percentage
                    const percCell = row.insertCell();
                    percCell.textContent = item.salesPercentage.toFixed(1) + '%';
                });
            }
            
            function generateFinancialReport() {
                const reportType = document.getElementById('financialReportType').value;
                const period = document.getElementById('financialReportPeriod').value;
                const dateFrom = document.getElementById('financialReportDateFrom').value;
                const dateTo = document.getElementById('financialReportDateTo').value;
                
                // Get filtered invoices based on period
                let filteredInvoices = [...invoices];
                let filteredDebts = [...debts];
                let filteredPayments = [];
                
                // Collect all payments from debts
                debts.forEach(debt => {
                    debt.payments.forEach(payment => {
                        filteredPayments.push({
                            ...payment,
                            type: 'debt_payment',
                            amount: payment.amount,
                            description: `سداد دين للعميل ${debt.customer}`,
                            invoiceNumber: debt.invoiceNumber
                        });
                    });
                });
                
                // Add invoice payments
                filteredInvoices.forEach(invoice => {
                    filteredPayments.push({
                        date: invoice.createdAt,
                        type: 'invoice',
                        amount: parseFloat(invoice.totalAmount),
                        description: `فاتورة ${invoice.invoiceNumber} للعميل ${invoice.customer}`,
                        invoiceNumber: invoice.invoiceNumber,
                        method: invoice.paymentMethod
                    });
                });
                
                // Apply period filter
                if (period === 'today') {
                    const today = new Date().toISOString().split('T')[0];
                    filteredInvoices = filteredInvoices.filter(invoice => invoice.date.includes(today));
                    filteredPayments = filteredPayments.filter(payment => payment.date.includes(today));
                } else if (period === 'week') {
                    const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    filteredInvoices = filteredInvoices.filter(invoice => new Date(invoice.date) >= oneWeekAgo);
                    filteredPayments = filteredPayments.filter(payment => new Date(payment.date) >= oneWeekAgo);
                } else if (period === 'month') {
                    const oneMonthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                    filteredInvoices = filteredInvoices.filter(invoice => new Date(invoice.date) >= oneMonthAgo);
                    filteredPayments = filteredPayments.filter(payment => new Date(payment.date) >= oneMonthAgo);
                } else if (period === 'year') {
                    const oneYearAgo = new Date(Date.now() - 365 * 24 * 60 * 60 * 1000);
                    filteredInvoices = filteredInvoices.filter(invoice => new Date(invoice.date) >= oneYearAgo);
                    filteredPayments = filteredPayments.filter(payment => new Date(payment.date) >= oneYearAgo);
                } else if (period === 'custom' && dateFrom && dateTo) {
                    filteredInvoices = filteredInvoices.filter(invoice => 
                        invoice.date >= dateFrom && invoice.date <= dateTo
                    );
                    filteredPayments = filteredPayments.filter(payment => 
                        payment.date >= dateFrom && payment.date <= dateTo
                    );
                }
                
                // Calculate financial summary
                let totalSales = 0;
                let totalPurchases = 0; // In a real app, this would come from purchases data
                let totalExpenses = 0; // In a real app, this would come from expenses data
                
                filteredInvoices.forEach(invoice => {
                    totalSales += parseFloat(invoice.totalAmount);
                });
                
                // For demo purposes, we'll set some arbitrary values
                totalPurchases = totalSales * 0.6; // Assuming 60% cost of goods
                totalExpenses = totalSales * 0.1; // Assuming 10% expenses
                
                const netProfit = totalSales - totalPurchases - totalExpenses;
                
                // Update summary
                document.getElementById('totalSalesAmount').textContent = totalSales.toLocaleString() + ' دينار';
                document.getElementById('totalPurchasesAmount').textContent = totalPurchases.toLocaleString() + ' دينار';
                document.getElementById('totalExpensesAmount').textContent = totalExpenses.toLocaleString() + ' دينار';
                document.getElementById('netProfitAmount').textContent = netProfit.toLocaleString() + ' دينار';
                
                // Prepare report data based on report type
                let reportData = [];
                
                if (reportType === 'profit') {
                    reportData = [
                        { date: new Date().toISOString(), type: 'المبيعات', description: 'إجمالي المبيعات', amount: totalSales },
                        { date: new Date().toISOString(), type: 'المشتريات', description: 'إجمالي المشتريات', amount: -totalPurchases },
                        { date: new Date().toISOString(), type: 'المصروفات', description: 'إجمالي المصروفات', amount: -totalExpenses },
                        { date: new Date().toISOString(), type: 'صافي الربح', description: 'صافي الربح', amount: netProfit }
                    ];
                } else if (reportType === 'expenses') {
                    // In a real app, this would come from actual expenses data
                    reportData = [
                        { date: new Date().toISOString(), type: 'مصروفات', description: 'إيجار المحل', amount: -500000, method: 'cash' },
                        { date: new Date().toISOString(), type: 'مصروفات', description: 'رواتب الموظفين', amount: -1000000, method: 'bank' },
                        { date: new Date().toISOString(), type: 'مصروفات', description: 'فواتير الخدمات', amount: -200000, method: 'cash' }
                    ];
                } else if (reportType === 'debts') {
                    reportData = filteredPayments
                        .filter(payment => payment.type === 'debt_payment')
                        .map(payment => ({
                            ...payment,
                            type: 'سداد دين',
                            amount: -payment.amount
                        }));
                } else if (reportType === 'cashflow') {
                    reportData = filteredPayments.map(payment => {
                        if (payment.type === 'invoice') {
                            return {
                                ...payment,
                                type: 'فاتورة بيع',
                                amount: payment.amount
                            };
                        } else {
                            return {
                                ...payment,
                                type: 'سداد دين',
                                amount: -payment.amount
                            };
                        }
                    });
                    
                    // Sort by date
                    reportData.sort((a, b) => new Date(b.date) - new Date(a.date));
                }
                
                // Render report table
                renderFinancialReportTable(reportData);
            }
            
            function renderFinancialReportTable(data) {
                financialReportTableBody.innerHTML = '';
                
                data.forEach(item => {
                    const row = financialReportTableBody.insertRow();
                    
                    // Date
                    const dateCell = row.insertCell();
                    dateCell.textContent = new Date(item.date).toLocaleDateString();
                    
                    // Type
                    const typeCell = row.insertCell();
                    typeCell.textContent = item.type;
                    
                    // Description
                    const descCell = row.insertCell();
                    descCell.textContent = item.description;
                    
                    // Amount
                    const amountCell = row.insertCell();
                    amountCell.textContent = item.amount.toLocaleString();
                    amountCell.style.color = item.amount >= 0 ? 'green' : 'red';
                    
                    // Payment Method
                    const methodCell = row.insertCell();
                    methodCell.textContent = item.method ? getPaymentMethodName(item.method) : '--';
                    
                    // Notes
                    const notesCell = row.insertCell();
                    notesCell.textContent = item.notes || '--';
                });
            }
            
            // Daily Sales Functions
            function loadDailySales() {
                const selectedDate = document.getElementById('dailySalesDate').value;
                
                if (!selectedDate) {
                    showToast('الرجاء اختيار تاريخ', 'error');
                    return;
                }
                
                const filteredInvoices = invoices.filter(invoice => 
                    invoice.date.includes(selectedDate) && invoice.status === 'completed'
                );
                
                // Update summary
                document.getElementById('dailyInvoicesCount').textContent = filteredInvoices.length;
                
                const totalSales = filteredInvoices.reduce((sum, invoice) => 
                    sum + parseFloat(invoice.totalAmount), 0);
                document.getElementById('dailyTotalSales').textContent = totalSales.toLocaleString() + ' دينار';
                
                const cashSales = filteredInvoices
                    .filter(invoice => invoice.paymentMethod === 'cash')
                    .reduce((sum, invoice) => sum + parseFloat(invoice.totalAmount), 0);
                document.getElementById('dailyCashSales').textContent = cashSales.toLocaleString() + ' دينار';
                
                const cardSales = filteredInvoices
                    .filter(invoice => invoice.paymentMethod === 'card')
                    .reduce((sum, invoice) => sum + parseFloat(invoice.totalAmount), 0);
                document.getElementById('dailyCardSales').textContent = cardSales.toLocaleString() + ' دينار';
                
                // Render table
                renderDailySalesTable(filteredInvoices);
            }
            
            function renderDailySalesTable(invoices) {
                dailySalesTableBody.innerHTML = '';
                
                invoices.forEach(invoice => {
                    const row = dailySalesTableBody.insertRow();
                    
                    // Invoice Number
                    const numberCell = row.insertCell();
                    numberCell.textContent = invoice.invoiceNumber;
                    
                    // Time
                    const timeCell = row.insertCell();
                    timeCell.textContent = invoice.date.split(' ')[1] || '';
                    
                    // Customer
                    const customerCell = row.insertCell();
                    customerCell.textContent = invoice.customer;
                    
                    // Items Count
                    const countCell = row.insertCell();
                    countCell.textContent = invoice.items.length;
                    
                    // Total Amount
                    const totalCell = row.insertCell();
                    totalCell.textContent = invoice.totalAmount.toLocaleString();
                    
                    // Payment Method
                    const paymentCell = row.insertCell();
                    paymentCell.textContent = getPaymentMethodName(invoice.paymentMethod);
                    
                    // Actions
                    const actionsCell = row.insertCell();
                    
                    // View button
                    const viewBtn = document.createElement('button');
                    viewBtn.className = 'action-btn edit-btn';
                    viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
                    viewBtn.title = 'عرض';
                    viewBtn.onclick = () => showInvoiceModal(invoice);
                    actionsCell.appendChild(viewBtn);
                });
            }
            
            // Settings Functions
            function saveGeneralSettings() {
                const newSettings = {
                    shopName: document.getElementById('shopNameSetting').value.trim(),
                    shopAddress: document.getElementById('shopAddress').value.trim(),
                    shopPhone: document.getElementById('shopPhone').value.trim(),
                    shopTaxNumber: document.getElementById('shopTaxNumber').value.trim(),
                    defaultTaxRate: parseFloat(document.getElementById('defaultTaxRate').value) || 0,
                    currencySymbol: document.getElementById('currencySymbol').value.trim(),
                    printHeader: document.getElementById('printHeader').value.trim(),
                    printFooter: document.getElementById('printFooter').value.trim()
                };
                
                if (!newSettings.shopName) {
                    showToast('الرجاء إدخال اسم المحل', 'error');
                    return;
                }
                
                settings = { ...settings, ...newSettings };
                saveData();
                applySettings();
                
                showToast('تم حفظ الإعدادات بنجاح');
            }
            
            function renderUsersTable() {
                usersTableBody.innerHTML = '';
                
                users.forEach((user, index) => {
                    const row = usersTableBody.insertRow();
                    
                    // Username
                    const userCell = row.insertCell();
                    userCell.textContent = user.username;
                    
                    // Role
                    const roleCell = row.insertCell();
                    roleCell.textContent = getUserRoleName(user.role);
                    
                    // Created At
                    const dateCell = row.insertCell();
                    dateCell.textContent = new Date(user.createdAt).toLocaleDateString();
                    
                    // Status
                    const statusCell = row.insertCell();
                    statusCell.textContent = user.active ? 'نشط' : 'غير نشط';
                    statusCell.style.color = user.active ? 'green' : 'red';
                    
                    // Actions
                    const actionsCell = row.insertCell();
                    
                    // Edit button
                    const editBtn = document.createElement('button');
                    editBtn.className = 'action-btn edit-btn';
                    editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                    editBtn.title = 'تعديل';
                    editBtn.onclick = () => editUser(index);
                    actionsCell.appendChild(editBtn);
                    
                    // Toggle status button
                    const statusBtn = document.createElement('button');
                    statusBtn.className = 'action-btn ' + (user.active ? 'delete-btn' : 'success');
                    statusBtn.innerHTML = user.active ? '<i class="fas fa-ban"></i>' : '<i class="fas fa-check"></i>';
                    statusBtn.title = user.active ? 'تعطيل' : 'تفعيل';
                    statusBtn.onclick = () => toggleUserStatus(index);
                    actionsCell.appendChild(statusBtn);
                    
                    // Delete button (only for non-admin users)
                    if (user.role !== 'admin') {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'action-btn delete-btn';
                        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                        deleteBtn.title = 'حذف';
                        deleteBtn.onclick = () => deleteUser(index);
                        actionsCell.appendChild(deleteBtn);
                    }
                });
            }
            
            function getUserRoleName(role) {
                const roles = {
                    'admin': 'مدير',
                    'cashier': 'كاشير',
                    'inventory': 'مخازن'
                };
                return roles[role] || role;
            }
            
            function addUser() {
                const username = document.getElementById('newUsername').value.trim();
                const password = document.getElementById('newUserPassword').value;
                const role = document.getElementById('newUserRole').value;
                
                if (!username || !password) {
                    showToast('الرجاء إدخال اسم المستخدم وكلمة المرور', 'error');
                    return;
                }
                
                // Check if username already exists
                if (users.some(u => u.username === username)) {
                    showToast('اسم المستخدم موجود بالفعل', 'error');
                    return;
                }
                
                // Add new user
                users.push({
                    username,
                    password, // In a real app, this should be hashed
                    role,
                    active: true,
                    createdAt: new Date().toISOString()
                });
                
                saveData();
                
                // Clear form
                document.getElementById('newUsername').value = '';
                document.getElementById('newUserPassword').value = '';
                document.getElementById('newUserRole').value = 'cashier';
                
                // Render table
                renderUsersTable();
                
                // Show success message
                showToast('تم إضافة المستخدم بنجاح');
            }
            
            function editUser(index) {
                // In a real app, this would open a modal to edit user details
                alert(`تعديل مستخدم: ${users[index].username}\nهذه الميزة تحت التطوير`);
            }
            
            function toggleUserStatus(index) {
                users[index].active = !users[index].active;
                saveData();
                renderUsersTable();
                
                showToast(`تم ${users[index].active ? 'تفعيل' : 'تعطيل'} المستخدم بنجاح`);
            }
            
            function deleteUser(index) {
                if (!confirm('هل أنت متأكد من حذف هذا المستخدم؟')) return;
                
                users.splice(index, 1);
                saveData();
                renderUsersTable();
                
                showToast('تم حذف المستخدم بنجاح');
            }
            
            function loadBackupFiles() {
                // In a real app, this would load actual backup files
                const demoBackups = [
                    { name: 'backup_20230615.json', type: 'كامل', size: '2.5 MB', date: '2023-06-15' },
                    { name: 'backup_20230601.json', type: 'كامل', size: '2.3 MB', date: '2023-06-01' },
                    { name: 'invoices_202305.json', type: 'الفواتير', size: '1.2 MB', date: '2023-05-31' }
                ];
                
                renderBackupsTable(demoBackups);
            }
            
            function renderBackupsTable(backups) {
                backupsTableBody.innerHTML = '';
                
                backups.forEach(backup => {
                    const row = backupsTableBody.insertRow();
                    
                    // File Name
                    const nameCell = row.insertCell();
                    nameCell.textContent = backup.name;
                    
                    // Type
                    const typeCell = row.insertCell();
                    typeCell.textContent = backup.type;
                    
                    // Size
                    const sizeCell = row.insertCell();
                    sizeCell.textContent = backup.size;
                    
                    // Date
                    const dateCell = row.insertCell();
                    dateCell.textContent = backup.date;
                    
                    // Actions
                    const actionsCell = row.insertCell();
                    
                    // Download button
                    const downloadBtn = document.createElement('button');
                    downloadBtn.className = 'action-btn edit-btn';
                    downloadBtn.innerHTML = '<i class="fas fa-download"></i>';
                    downloadBtn.title = 'تحميل';
                    downloadBtn.onclick = () => downloadBackup(backup.name);
                    actionsCell.appendChild(downloadBtn);
                    
                    // Delete button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'action-btn delete-btn';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.title = 'حذف';
                    deleteBtn.onclick = () => deleteBackup(backup.name);
                    actionsCell.appendChild(deleteBtn);
                });
            }
            
            function createBackup() {
                const backupType = document.getElementById('backupType').value;
                const format = document.getElementById('backupFormat').value;
                
                // In a real app, this would create an actual backup file
                showToast(`تم إنشاء نسخة احتياطية (${backupType}) بصيغة ${format}`);
                
                // Refresh backups list
                loadBackupFiles();
            }
            
            function downloadBackup(filename) {
                // In a real app, this would download the actual backup file
                alert(`سيتم تحميل الملف: ${filename}\nهذه الميزة تحت التطوير`);
            }
            
            function deleteBackup(filename) {
                if (!confirm(`هل أنت متأكد من حذف النسخة الاحتياطية ${filename}؟`)) return;
                
                // In a real app, this would delete the actual backup file
                showToast(`تم حذف النسخة الاحتياطية ${filename}`);
                
                // Refresh backups list
                loadBackupFiles();
            }
            
            function restoreBackup() {
                // In a real app, this would open a file dialog to select a backup file
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json,.csv,.xlsx';
                
                fileInput.onchange = e => {
                    const file = e.target.files[0];
                    if (file) {
                        if (confirm(`هل أنت متأكد من استعادة النسخة الاحتياطية من ${file.name}؟ سيتم استبدال جميع البيانات الحالية.`)) {
                            // In a real app, this would actually restore the backup
                            showToast(`تم استعادة النسخة الاحتياطية من ${file.name}`);
                            
                            // Refresh all data
                            loadData();
                            renderProductsTable();
                            renderInvoicesTable();
                            renderDebtsTable();
                        }
                    }
                };
                
                fileInput.click();
            }
            
            // Show toast notification
            function showToast(message, type = 'success') {
                toastMessage.textContent = message;
                toastNotification.className = 'toast ' + type;
                toastNotification.classList.add('show');
                
                setTimeout(() => {
                    toastNotification.classList.remove('show');
                }, 3000);
            }
            
            // Initialize the app
            init();
        });
    </script>
</body>
</html>
